<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta name="robots" content="noindex">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Winds資產分配計畫</title>
    <!-- 載入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- 載入 Google Fonts (Noto Serif TC for titles, Noto Sans TC for body) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&family=Noto+Serif+TC:wght=500;700&display=swap" rel="stylesheet">
    
    <style>
        /* Wabi-Sabi Style Configuration */
        :root {
            /* 主色: 沉靜、泥土色調的深棕灰 */
            --color-primary: #544C4A; 
            /* 背景色: 柔和、米白色的亞麻色 */
            --color-secondary: #F7F4F1; 
            /* 點綴色: 溫暖、內斂的陶土色 */
            --color-accent: #A88F78; 
            /* 邊框/線條: 略淺的柔和灰色 */
            --color-border: #E0DCD7; 
        }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--color-secondary);
            color: var(--color-primary);
        }

        .font-serif-tc {
            font-family: 'Noto Serif TC', serif;
        }

        .bg-primary { background-color: var(--color-primary); }
        .text-primary { color: var(--color-primary); }
        .bg-accent { background-color: var(--color-accent); }
        .text-accent { color: var(--color-accent); }
        .border-base { border-color: var(--color-border); }
        
        /* 底部導航按鈕樣式 */
        .nav-button.active {
            color: var(--color-accent);
            border-top: 2px solid var(--color-accent);
        }

        /* 隱藏滾動條 */
        .custom-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .custom-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Modal 動畫 */
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 300ms, transform 300ms;
        }
        .modal-exit {
            opacity: 1;
            transform: scale(1);
        }
        .modal-exit-active {
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 200ms, transform 200ms;
        }
    </style>
</head>
<body class="min-h-screen antialiased flex flex-col">

    <!-- 頂部標題 -->
    <header class="bg-secondary/80 backdrop-blur-sm shadow-sm sticky top-0 z-10 border-b border-base">
        <div class="max-w-xl mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-serif-tc font-bold text-primary tracking-wide">
                <i class="fas fa-seedling text-accent mr-2"></i>Winds 資產分配計畫
            </h1>
            <!-- 右側功能按鈕區 -->
            <div class="flex items-center space-x-3">
                <!-- 資料管理按鈕 -->
                <button onclick="openDataModal()" class="text-gray-400 hover:text-primary transition p-1" title="資料管理(匯入/匯出)">
                    <i class="fas fa-database text-lg"></i>
                </button>
                <!-- 股票管理按鈕 -->
                <button onclick="openStockModal()" class="text-accent hover:text-primary transition p-1" title="管理持股與股價">
                    <i class="fas fa-chart-line text-lg"></i>
                </button>
                <!-- 新增：設定按鈕 -->
                <button onclick="openSettingsModal()" class="text-gray-500 hover:text-primary transition p-1" title="設定與帳戶管理">
                    <i class="fas fa-cog text-lg"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- 主要內容區塊 -->
    <main id="main-content" class="flex-grow max-w-xl mx-auto w-full p-4 pb-20 custom-scrollbar">
        
        <!-- Tab 內容容器 -->
        <div id="tab-container" class="space-y-6">
            
            <!-- 1. 資產分配 Tab (Assets) -->
            <section id="assets-tab" class="tab-content hidden">
                <h2 class="text-2xl font-serif-tc font-bold mb-4">個人資產概覽</h2>
                <div id="asset-summary" class="bg-primary text-white p-4 rounded-xl shadow-lg mb-6">
                    <p class="text-sm opacity-80">個人總淨資產 (TWD)</p>
                    <p id="total-asset-twd" class="text-3xl font-bold mt-1 tracking-wider">TWD 0</p>
                    <p id="exchange-rate-display" class="text-xs opacity-70 mt-2">
                        匯率更新：USD=32.0, CNY=4.4
                    </p>
                    <!-- 新增未實現損益顯示 -->
                    <div id="total-unrealized-pl" class="mt-3 pt-3 border-t border-white/20 text-sm flex justify-between">
                        <span>證券未實現損益:</span>
                        <span class="font-bold">--</span>
                    </div>
                </div>

                <h3 class="text-xl font-serif-tc font-semibold mb-3 border-b pb-2 border-base">投資與帳戶明細</h3>
                <div id="asset-accordion" class="space-y-3">
                    <!-- Assets will be rendered here -->
                </div>
            </section>
            
            <!-- 2. 每月理財規劃 Tab (Plan) -->
            <section id="plan-tab" class="tab-content hidden">
                <h2 class="text-2xl font-serif-tc font-bold mb-4">每月理財規劃</h2>
                
                <!-- 固定收入與支出區塊 -->
                <div class="bg-white p-4 rounded-xl shadow-lg mb-6">
                    <!-- 收入 -->
                    <div class="flex justify-between items-center pb-2 border-b border-base mb-3">
                        <p class="text-lg font-semibold text-primary">每月固定收入</p>
                        <div class="flex items-center">
                            <span class="text-xl font-bold text-green-700 mr-1">TWD</span>
                            <input type="number" id="monthly-income-input" 
                                   class="text-xl font-bold text-green-700 w-24 bg-transparent border-b border-dashed border-green-700/50 focus:outline-none focus:border-green-700 text-right"
                                   onchange="updateMonthlyIncome(this.value)">
                        </div>
                    </div>
                    
                    <!-- 總固定支出 -->
                    <div>
                        <button class="w-full flex justify-between items-center focus:outline-none" onclick="toggleAccordion('fixed-expenses-details-container')">
                            <div class="flex items-center">
                                <p class="text-lg font-semibold text-primary mr-2">每月總固定支出</p>
                                <i class="fas fa-chevron-down text-xs text-gray-400 transition-transform duration-300" id="fixed-expenses-details-container-icon"></i>
                            </div>
                            <p id="total-fixed-expense" class="text-xl font-bold text-red-700">TWD 0</p>
                        </button>
                        
                        <!-- 固定支出細項 -->
                        <div id="fixed-expenses-details-container" class="hidden mt-3 pt-3 border-t border-dashed border-gray-200">
                            <div id="fixed-expenses-list" class="space-y-3">
                                <!-- Fixed expenses items will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 每月流動支出 -->
                <h3 class="text-xl font-serif-tc font-semibold mb-3 border-b pb-2 border-base">每月流動支出</h3>
                <div id="fluid-expenses-list" class="space-y-2 bg-white p-4 rounded-xl shadow-md border border-base mb-6">
                    <!-- Fluid expenses will be rendered here -->
                </div>

                <!-- 本月信用卡應繳金額 -->
                <div class="bg-white p-4 rounded-xl shadow-lg mb-6 border border-base">
                    <button class="w-full flex justify-between items-center pb-2 border-b border-base focus:outline-none" onclick="toggleAccordion('bill-due-content')">
                        <div class="flex items-center">
                             <h3 class="text-lg font-serif-tc font-bold text-primary">
                                <i class="fas fa-file-invoice-dollar text-accent mr-2"></i>本月信用卡應繳金額
                            </h3>
                            <span class="ml-2 text-xs text-white bg-red-500 px-2 py-1 rounded-full">需繳款</span>
                        </div>
                        <i class="fas fa-chevron-down text-sm transition-transform duration-300 transform" id="bill-due-content-icon"></i>
                    </button>
                    
                    <div id="bill-due-content" class="hidden mt-4 space-y-2">
                        <div id="bill-due-list" class="space-y-3">
                            <!-- Content populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- 下月卡費預備金監控 -->
                <div class="bg-white p-4 rounded-xl shadow-lg mb-6 border border-base">
                    <button class="w-full flex justify-between items-center pb-2 border-b border-base focus:outline-none" onclick="toggleAccordion('credit-card-prep-content')">
                        <div class="flex items-center">
                             <h3 class="text-lg font-serif-tc font-bold text-primary">
                                <i class="fas fa-credit-card text-accent mr-2"></i>下月卡費預備金監控
                            </h3>
                            <span class="ml-2 text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">依帳單週期計算</span>
                        </div>
                        <i class="fas fa-chevron-down text-sm transition-transform duration-300 transform" id="credit-card-prep-content-icon"></i>
                    </button>
                    
                    <div id="credit-card-prep-content" class="hidden mt-4 space-y-4">
                        <div id="credit-card-prep-list" class="space-y-4">
                            <!-- Content populated by JS -->
                        </div>
                    </div>
                </div>
                
            </section>

            <!-- 3. 記帳 Tab (Bookkeeping) -->
            <section id="bookkeeping-tab" class="tab-content hidden">
                <h2 class="text-2xl font-serif-tc font-bold mb-4">每日記帳</h2>
                
                <!-- 記帳表單 -->
                <div class="bg-white p-4 rounded-xl shadow-lg mb-6 border border-base">
                    <h3 class="text-xl font-semibold mb-4">新增支出/收入/轉帳</h3>
                    <form id="transaction-form" class="space-y-4">
                        
                        <div>
                            <!-- 修改：日期寬度與 padding -->
                            <input type="date" id="transaction-date" required class="w-full max-w-[200px] p-2 border rounded-lg focus:ring-accent focus:border-accent bg-white text-gray-700 font-medium">
                        </div>

                        <div class="flex space-x-2">
                             <!-- 修改：padding -->
                             <select id="transaction-type" class="w-24 p-2 border rounded-lg focus:ring-accent focus:border-accent bg-gray-50" required>
                                <option value="expense" selected>支出</option>
                                <option value="income">收入</option>
                                <option value="transfer">轉帳</option>
                            </select>
                            <!-- 修改：padding 與 min-w-0 -->
                            <select id="transaction-category" class="flex-1 min-w-0 p-2 border rounded-lg focus:ring-accent focus:border-accent bg-white" required>
                                <option value="" disabled selected>分類</option>
                                <!-- Categories populated by JS -->
                            </select>
                            <!-- 修改：padding 與 min-w-0 -->
                            <select id="transaction-subcategory" class="flex-1 min-w-0 p-2 border rounded-lg focus:ring-accent focus:border-accent bg-white" required>
                                <option value="" disabled selected>細項</option>
                                <!-- Subcategories populated by JS -->
                            </select>
                        </div>
                        
                        <div id="row-account-selection" class="flex space-x-2">
                            <select id="transaction-account" class="w-full p-3 border rounded-lg focus:ring-accent focus:border-accent" required>
                                <option value="" disabled selected>選擇帳戶/卡片</option>
                            </select>
                        </div>

                        <div class="flex space-x-2">
                            <input type="number" id="transaction-amount" placeholder="金額" required min="0" step="any"
                                   class="w-full p-3 border rounded-l-lg focus:ring-accent focus:border-accent">
                            <select id="transaction-currency" class="p-3 border rounded-r-lg focus:ring-accent focus:border-accent w-20">
                                <option value="TWD" selected>TWD</option>
                                <option value="USD">USD</option>
                                <option value="CNY">CNY</option>
                            </select>
                        </div>

                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-700">備註</label>
                            <input type="text" id="transaction-note" placeholder="輸入備註事項..." 
                                   class="w-full p-3 border rounded-lg focus:ring-accent focus:border-accent bg-white text-gray-700">
                        </div>

                        <button type="submit" class="w-full bg-primary text-white py-3 rounded-xl font-bold hover:bg-primary/90 transition duration-150 shadow-md">
                            <i class="fas fa-plus mr-2"></i>記錄
                        </button>
                    </form>
                </div>

                <!-- 歷史紀錄 -->
                <div class="bg-white rounded-xl shadow-md border border-base mb-6 overflow-hidden">
                    <button class="w-full flex justify-between items-center p-4 font-serif-tc font-semibold text-xl text-primary bg-secondary/20" onclick="toggleAccordion('history-accordion-content')">
                        <span>歷史記帳紀錄</span>
                        <i class="fas fa-chevron-down text-sm ml-3 transition-transform duration-300 transform" id="history-accordion-content-icon"></i>
                    </button>
                    
                    <div id="history-accordion-content" class="hidden">
                        <ul id="transaction-history" class="space-y-2 p-2">
                            <li class="text-center text-gray-500 p-4">載入中...</li>
                        </ul>
                        <div id="load-more-container" class="p-3 text-center border-t border-base/50 hidden">
                            <button onclick="loadMoreTransactions()" class="text-accent font-semibold text-sm hover:text-primary transition">
                                <i class="fas fa-ellipsis-h mr-1"></i>查看更多紀錄
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 本月支出/收入統計 -->
                <h3 class="text-xl font-serif-tc font-semibold mb-3 border-b pb-2 border-base mt-8">本月支出/收入統計</h3>
                <div class="bg-white p-4 rounded-xl shadow-lg border border-base">
                    <div class="flex justify-between items-center mb-4">
                        <p id="stats-date-range" class="text-sm text-gray-500 font-medium">統計區間: --/-- ~ --/--</p>
                        <span class="bg-accent/10 text-accent text-xs px-2 py-1 rounded-full">每月5號結算</span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4 text-center">
                        <div class="p-2 bg-green-50 rounded-lg">
                            <p class="text-sm text-gray-600">本月總收入</p>
                            <p id="stats-total-income" class="text-xl font-bold text-green-700 mt-1">TWD 0</p>
                        </div>
                        <div class="p-2 bg-red-50 rounded-lg">
                            <p class="text-sm text-gray-600">本月總支出</p>
                            <p id="stats-total-expense" class="text-xl font-bold text-red-700 mt-1">TWD 0</p>
                        </div>
                    </div>

                    <div id="monthly-stats-list" class="space-y-3">
                        <!-- Stats will be rendered here -->
                    </div>
                </div>

                <!-- 本年度每月支出/收入統計 -->
                <h3 class="text-xl font-serif-tc font-semibold mb-3 border-b pb-2 border-base mt-8">本年度每月支出/收入統計</h3>
                <div class="bg-white p-4 rounded-xl shadow-lg border border-base">
                     <p class="text-sm text-gray-500 font-medium mb-3 text-right">統計週期：自然月 (每月1號~月底)</p>
                     <div id="yearly-stats-container" class="space-y-3">
                         <!-- Yearly stats populated by JS -->
                     </div>
                </div>

                <!-- 歷年每月支出/收入統計 -->
                <h3 class="text-xl font-serif-tc font-semibold mb-3 border-b pb-2 border-base mt-8">歷年每月支出/收入統計</h3>
                <div class="bg-white p-4 rounded-xl shadow-lg border border-base">
                     <div class="flex justify-between items-center mb-4">
                        <label for="history-year-select" class="text-primary font-medium">選擇年度：</label>
                        <select id="history-year-select" class="p-2 border rounded-lg focus:ring-accent focus:border-accent bg-secondary/20">
                            <!-- Years populated by JS -->
                        </select>
                     </div>
                     <div id="history-year-stats-container" class="space-y-3">
                         <p class="text-center text-gray-500 py-4">請選擇年度以查看統計</p>
                     </div>
                </div>

            </section>
            
            <!-- 4. 共同帳戶 Tab (Joint Account) -->
            <section id="joint-tab" class="tab-content hidden">
                <h2 class="text-2xl font-serif-tc font-bold mb-4">共同帳戶管理</h2>
                
                <div class="bg-accent text-white p-4 rounded-xl shadow-lg mb-6">
                    <p class="text-sm opacity-80">共同帳戶目前總資產 (TWD)</p>
                    <p id="joint-asset-twd" class="text-3xl font-bold mt-1 tracking-wider">TWD 0</p>
                </div>
                
                <h3 class="text-xl font-serif-tc font-semibold mb-3 border-b pb-2 border-base">每月共同帳戶收支概覽</h3>
                <div class="bg-white p-4 rounded-xl shadow-lg border border-base">
                    <!-- Dynamic Joint Expenses Content -->
                    <div id="joint-expenses-placeholder" class="space-y-2">
                        <!-- Content will be injected by renderJointAccount -->
                    </div>
                </div>

            </section>

            <!-- 5. 距離存到100萬還有 Tab (Goal) -->
            <section id="goal-tab" class="tab-content hidden">
                <h2 class="text-2xl font-serif-tc font-bold mb-4">百萬目標追蹤</h2>
                
                <div class="bg-white p-6 rounded-xl shadow-lg border-2 border-accent text-center">
                    <p class="text-lg text-primary font-serif-tc">目標金額</p>
                    <p class="text-4xl font-bold text-accent my-3 tracking-wider">TWD 1,000,000</p>
                    
                    <div id="goal-status">
                        <!-- Goal calculation results here -->
                    </div>
                </div>

                <div class="mt-8 bg-white p-4 rounded-xl shadow-lg border border-base">
                    <h3 class="text-xl font-semibold mb-3">資產與目標進度</h3>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div id="goal-progress-bar" class="bg-accent h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <p id="goal-percent-display" class="text-right text-sm mt-1 text-gray-600">0%</p>
                </div>
            </section>

        </div>
    </main>

    <!-- 底部導航列 -->
    <nav class="fixed bottom-0 left-0 w-full bg-white border-t border-base shadow-2xl z-20">
        <div class="max-w-xl mx-auto flex justify-around">
            <button class="nav-button flex flex-col items-center justify-center p-3 text-gray-500 transition duration-200 active" data-tab="assets">
                <i class="fas fa-money-check-dollar text-xl"></i>
                <span class="text-xs mt-1">資產分配</span>
            </button>
            <button class="nav-button flex flex-col items-center justify-center p-3 text-gray-500 transition duration-200" data-tab="plan">
                <i class="fas fa-chart-pie text-xl"></i>
                <span class="text-xs mt-1">理財規劃</span>
            </button>
            <button class="nav-button flex flex-col items-center justify-center p-3 text-gray-500 transition duration-200" data-tab="bookkeeping">
                <i class="fas fa-file-invoice-dollar text-xl"></i>
                <span class="text-xs mt-1">記帳</span>
            </button>
            <button class="nav-button flex flex-col items-center justify-center p-3 text-gray-500 transition duration-200" data-tab="joint">
                <i class="fas fa-handshake text-xl"></i>
                <span class="text-xs mt-1">共同帳戶</span>
            </button>
            <button class="nav-button flex flex-col items-center justify-center p-3 text-gray-500 transition duration-200" data-tab="goal">
                <i class="fas fa-bullseye text-xl"></i>
                <span class="text-xs mt-1">百萬目標</span>
            </button>
        </div>
    </nav>
    
    <!-- 編輯 Modal (Hidden by default) -->
    <div id="edit-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeEditModal()"></div>
        <div class="bg-white w-11/12 max-w-md p-6 rounded-2xl shadow-2xl relative z-10 transform transition-all scale-100">
            <h3 class="text-xl font-bold mb-4 text-primary">修改記帳紀錄</h3>
            <form id="edit-transaction-form" class="space-y-4">
                <input type="hidden" id="edit-id">
                
                <div>
                    <label class="block text-sm text-gray-600 mb-1">日期</label>
                    <input type="date" id="edit-date" required class="w-full p-3 border rounded-lg focus:ring-accent focus:border-accent">
                </div>

                <div>
                    <label class="block text-sm text-gray-600 mb-1">金額</label>
                    <input type="number" id="edit-amount" required min="0" step="any" class="w-full p-3 border rounded-lg focus:ring-accent focus:border-accent">
                </div>
                
                <div>
                    <label class="block text-sm text-gray-600 mb-1">備註</label>
                    <input type="text" id="edit-note" class="w-full p-3 border rounded-lg focus:ring-accent focus:border-accent">
                </div>

                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" onclick="closeEditModal()" class="px-4 py-2 text-gray-500 hover:text-gray-700 font-medium">取消</button>
                    <button type="submit" class="px-6 py-2 bg-accent text-white rounded-lg font-bold hover:bg-accent/90 shadow-md">儲存修改</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 刪除確認 Modal -->
    <div id="delete-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeDeleteModal()"></div>
        <div class="bg-white w-11/12 max-w-sm p-6 rounded-2xl shadow-2xl relative z-10 transform transition-all scale-100 text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
            </div>
            <h3 class="text-xl font-bold mb-2 text-primary">確定要刪除嗎？</h3>
            <p class="text-sm text-gray-500 mb-6">此動作無法復原，您確定要刪除這筆記帳紀錄嗎？</p>
            
            <div class="flex space-x-3">
                <button onclick="closeDeleteModal()" class="flex-1 py-2.5 bg-gray-100 text-gray-700 rounded-xl font-bold hover:bg-gray-200 transition">取消</button>
                <button onclick="confirmDelete()" class="flex-1 py-2.5 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 shadow-md transition">確認刪除</button>
            </div>
        </div>
    </div>

    <!-- 資料管理 Modal -->
    <div id="data-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeDataModal()"></div>
        <div class="bg-white w-11/12 max-w-sm p-6 rounded-2xl shadow-2xl relative z-10 transform transition-all scale-100 text-center">
            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-database text-xl text-blue-600"></i>
            </div>
            <h3 class="text-xl font-bold mb-4 text-primary">資料管理</h3>
            <p class="text-sm text-gray-500 mb-6">備份目前所有資料或從檔案還原</p>
            
            <div class="space-y-3">
                <button onclick="exportData()" class="w-full py-3 bg-primary text-white rounded-xl font-bold hover:bg-primary/90 shadow-md transition flex items-center justify-center">
                    <i class="fas fa-file-export mr-2"></i>匯出資料 (備份)
                </button>
                
                <button onclick="triggerImport()" class="w-full py-3 bg-white text-primary border-2 border-primary rounded-xl font-bold hover:bg-gray-50 transition flex items-center justify-center">
                    <i class="fas fa-file-import mr-2"></i>匯入資料 (還原)
                </button>
                <input type="file" id="import-file" accept=".json" class="hidden" onchange="handleFileImport(this)">
            </div>
            
            <button onclick="closeDataModal()" class="mt-6 text-gray-400 hover:text-gray-600 text-sm">關閉</button>
        </div>
    </div>

    <!-- 新增：設定 Modal (帳戶/卡片管理) -->
    <div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeSettingsModal()"></div>
        <div class="bg-white w-11/12 max-w-lg p-6 rounded-2xl shadow-2xl relative z-10 transform transition-all scale-100 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-primary flex items-center">
                <i class="fas fa-cog mr-2 text-accent"></i>設定與帳戶管理
            </h3>
            
            <!-- Tab 切換 -->
            <div class="flex border-b border-gray-200 mb-4">
                <button onclick="switchSettingsTab('accounts')" class="settings-tab-btn px-4 py-2 text-primary border-b-2 border-accent font-bold" data-target="settings-accounts-tab">帳戶管理</button>
                <button onclick="switchSettingsTab('cards')" class="settings-tab-btn px-4 py-2 text-gray-400 hover:text-primary" data-target="settings-cards-tab">信用卡管理</button>
            </div>

            <!-- Tab 1: 帳戶管理 -->
            <div id="settings-accounts-tab" class="settings-tab-content space-y-4">
                <p class="text-sm text-gray-500">管理您的銀行、證券或現金帳戶。這些帳戶會顯示在「資產分配」中。</p>
                
                <!-- 新增帳戶表單 -->
                <form id="add-account-form" class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <h4 class="font-bold text-sm text-primary mb-2">新增帳戶</h4>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input type="text" id="new-account-name" placeholder="帳戶名稱" required class="p-2 border rounded text-sm w-full">
                        <select id="new-account-currency" class="p-2 border rounded text-sm w-full">
                            <option value="TWD">TWD</option>
                            <option value="USD">USD</option>
                            <option value="CNY">CNY</option>
                        </select>
                    </div>
                    <div class="flex space-x-2">
                        <select id="new-account-type" class="p-2 border rounded text-sm flex-1">
                            <option value="cash">一般現金/銀行</option>
                            <option value="investment">證券/投資</option>
                        </select>
                        <button type="submit" class="bg-accent text-white px-4 py-2 rounded text-sm font-bold">新增</button>
                    </div>
                </form>

                <!-- 帳戶列表 -->
                <div id="settings-account-list" class="space-y-2 max-h-60 overflow-y-auto pr-1">
                    <!-- JS populated -->
                </div>
            </div>

            <!-- Tab 2: 信用卡管理 -->
            <div id="settings-cards-tab" class="settings-tab-content hidden space-y-4">
                <p class="text-sm text-gray-500">管理您的信用卡資訊。設定扣款帳戶與日期以進行理財規劃。</p>
                
                <!-- 新增信用卡表單 -->
                <form id="add-card-form" class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <h4 class="font-bold text-sm text-primary mb-2">新增信用卡</h4>
                    <div class="space-y-2">
                        <input type="text" id="new-card-name" placeholder="卡片名稱" required class="p-2 border rounded text-sm w-full">
                        <select id="new-card-linked" class="p-2 border rounded text-sm w-full" required>
                            <option value="" disabled selected>選擇扣款帳戶</option>
                            <!-- JS populated -->
                        </select>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-xs text-gray-500">結帳日</label>
                                <input type="number" id="new-card-billing" min="1" max="31" placeholder="日" required class="p-2 border rounded text-sm w-full">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">繳款日</label>
                                <input type="number" id="new-card-payment" min="1" max="31" placeholder="日" required class="p-2 border rounded text-sm w-full">
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-accent text-white py-2 rounded text-sm font-bold mt-2">新增卡片</button>
                    </div>
                </form>

                <!-- 卡片列表 -->
                <div id="settings-card-list" class="space-y-2 max-h-60 overflow-y-auto pr-1">
                    <!-- JS populated -->
                </div>
            </div>

            <div class="mt-4 text-right">
                 <button onclick="closeSettingsModal()" class="text-gray-400 hover:text-gray-600 text-sm">關閉</button>
            </div>
        </div>
    </div>

    <!-- 股票管理 Modal -->
    <div id="stock-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeStockModal()"></div>
        <div class="bg-white w-11/12 max-w-lg p-6 rounded-2xl shadow-2xl relative z-10 transform transition-all scale-100 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-primary flex items-center">
                <i class="fas fa-chart-pie mr-2 text-accent"></i>管理持股與股價
            </h3>
            
            <!-- Tab 切換 -->
            <div class="flex border-b border-gray-200 mb-4 overflow-x-auto">
                <button onclick="switchStockTab('update')" class="stock-tab-btn px-4 py-2 text-primary border-b-2 border-accent font-bold whitespace-nowrap" data-target="stock-update-tab">更新股價/成本</button>
                <button onclick="switchStockTab('trade')" class="stock-tab-btn px-4 py-2 text-gray-400 hover:text-primary whitespace-nowrap" data-target="stock-trade-tab">交易(買賣)</button>
                <button onclick="switchStockTab('add')" class="stock-tab-btn px-4 py-2 text-gray-400 hover:text-primary whitespace-nowrap" data-target="stock-add-tab">新增股票</button>
            </div>

            <!-- Tab 1: 更新股價與成本 -->
            <div id="stock-update-tab" class="stock-tab-content space-y-4">
                <p class="text-sm text-gray-500 mb-2">可修正目前的收盤價 (計算市值) 與 平均成本 (計算損益)。</p>
                <div id="stock-price-list" class="space-y-3">
                    <!-- 動態生成股票列表供輸入 -->
                </div>
                <button onclick="saveStockPrices()" class="w-full mt-4 bg-accent text-white py-2 rounded-xl font-bold hover:bg-accent/90">
                    儲存更新
                </button>
            </div>

            <!-- Tab 2: 交易 (買賣) -->
            <div id="stock-trade-tab" class="stock-tab-content hidden space-y-4">
                <form id="stock-trade-form" class="space-y-3">
                    <div>
                        <label class="block text-sm text-gray-600">動作</label>
                        <select id="trade-action" class="w-full p-2 border rounded-lg bg-gray-50">
                            <option value="buy">買入 (增加持股)</option>
                            <option value="sell">賣出 (減少持股)</option>
                        </select>
                    </div>
                    
                    <div id="existing-stock-select-group">
                        <label class="block text-sm text-gray-600">選擇股票</label>
                        <select id="trade-stock-id" class="w-full p-2 border rounded-lg">
                            <!-- Populated by JS -->
                        </select>
                    </div>

                    <div class="flex space-x-2">
                        <div class="flex-1">
                            <label class="block text-sm text-gray-600">成交股數</label>
                            <input type="number" id="trade-shares" class="w-full p-2 border rounded-lg" step="any" required>
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm text-gray-600">成交單價</label>
                            <input type="number" id="trade-price" class="w-full p-2 border rounded-lg" step="any" required>
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full bg-primary text-white py-2 rounded-xl font-bold hover:bg-primary/90 mt-4">
                        確認交易
                    </button>
                </form>
            </div>

            <!-- Tab 3: 新增股票 (Import) -->
            <div id="stock-add-tab" class="stock-tab-content hidden space-y-4">
                <p class="text-sm text-gray-500 mb-2">匯入/新增一檔新的股票資料到您的資產列表中。</p>
                <form id="stock-add-form" class="space-y-3 border-l-2 border-accent pl-3">
                    <div>
                        <label class="block text-sm text-gray-600">股票代號</label>
                        <input type="text" id="new-stock-code" class="w-full p-2 border rounded-lg" placeholder="例如: 2330" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600">股票名稱</label>
                        <input type="text" id="new-stock-name" class="w-full p-2 border rounded-lg" placeholder="例如: 台積電" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600">所屬帳戶</label>
                        <!-- 修改：更新選單名稱 (JS動態生成) -->
                        <select id="new-stock-account" class="w-full p-2 border rounded-lg">
                            <!-- populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600">幣別</label>
                        <select id="new-stock-currency" class="w-full p-2 border rounded-lg">
                            <option value="TWD">TWD</option>
                            <option value="USD">USD</option>
                        </select>
                    </div>
                    <div class="flex space-x-2">
                        <div class="flex-1">
                            <label class="block text-sm text-gray-600">初始股數</label>
                            <input type="number" id="new-stock-shares" class="w-full p-2 border rounded-lg" step="any" required>
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm text-gray-600">初始均價(成本)</label>
                            <input type="number" id="new-stock-cost" class="w-full p-2 border rounded-lg" step="any" required>
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-accent text-white py-2 rounded-xl font-bold hover:bg-accent/90 mt-4">
                        新增股票資料
                    </button>
                </form>
            </div>

            <div class="mt-4 text-right">
                 <button onclick="closeStockModal()" class="text-gray-400 hover:text-gray-600 text-sm">關閉</button>
            </div>
        </div>
    </div>

    <!-- JS 腳本區 -->
    <script>
        // --- 核心資料與設定 ---
        const LOCAL_STORAGE_KEY = 'winds_finance_data';
        const GOAL_AMOUNT = 1000000;
        
        const DEFAULT_OPEN_CATEGORIES = [
            'accordion-現金與帳戶',
            'accordion-證券戶'
        ];

        // 信用卡初始資料 (作為預設值，之後存入 appData)
        const CREDIT_CARDS_INITIAL = [
            { id: 'c1', name: "台新richart卡(玫瑰卡&gogo卡)", currency: "TWD", linkedAccount: "台新RICHART帳戶", billingDay: 7, paymentDay: 21 },
            { id: 'c2', name: "玉山ubear卡", currency: "TWD", linkedAccount: "玉山數位帳戶", billingDay: 5, paymentDay: 20 },
            { id: 'c3', name: "玉山unicard卡", currency: "TWD", linkedAccount: "玉山數位帳戶", billingDay: 5, paymentDay: 20 },
            { id: 'c4', name: "國泰cube卡", currency: "TWD", linkedAccount: "國泰cube帳戶", billingDay: 5, paymentDay: 20 },
            { id: 'c5', name: "星展現金回饋卡", currency: "TWD", linkedAccount: "星展銀行帳戶", billingDay: 7, paymentDay: 25 },
            { id: 'c6', name: "聯邦吉鶴卡", currency: "TWD", linkedAccount: "聯邦newnewbank帳戶", billingDay: 3, paymentDay: 18 }
        ];

        const EXPENSE_CATEGORIES = {
            "飲食": ["早餐", "午餐", "晚餐", "點心", "零食", "飲料", "其他"],
            "交通": ["加油費", "停車費", "計程車", "高鐵票", "火車票", "捷運票", "CAT-8625 支出", "MEL-7075 支出", "其他"],
            "娛樂": ["電影", "門票", "訂閱", "遊戲", "出遊旅費", "其他"],
            "購物": ["衣服", "配件", "美妝", "家電", "禮物", "巧郎運費", "日用品", "其他"],
            "個人": ["電話費", "捐款", "寵物", "保險", "其他"],
            "醫療": ["門診", "藥品", "醫療用品", "打針", "健康檢查", "其他"],
            "美容美髮": ["用頭髮", "按摩", "其他"],
            "家庭": ["孝親費", "懷孕相關", "小孩相關", "其他"]
        };

        const INCOME_CATEGORIES_LIST = [
            "薪水", "獎金", "韵禾苑", "還款", "股利", "交易", "利息", "退款", "隊友貢獻", "其他"
        ];

        // 帳戶初始資料 (作為預設值)
        const STATIC_ASSETS = [
            { id: 'asset-1', name: "現金", amount: 514, currency: "TWD", type: "cash", category: "現金與帳戶" }, 
            { id: 'asset-2', name: "IPASSMONEY", amount: 2231, currency: "TWD", type: "cash", category: "現金與帳戶" }, 
            { id: 'asset-3', name: "永豐大戶銀行帳戶", amount: 239, currency: "TWD", type: "cash", category: "現金與帳戶" }, 
            { id: 'asset-4', name: "台新RICHART(天然石帳戶)", amount: 11186, currency: "TWD", type: "cash", category: "現金與帳戶" }, 
            { id: 'asset-5', name: "中國信託(天然石帳戶)", amount: 24593, currency: "TWD", type: "cash", category: "現金與帳戶" }, 
            { id: 'asset-6', name: "國泰外幣帳戶", amount: 5.16, currency: "USD", type: "cash", category: "現金與帳戶" }, 
            { id: 'asset-7', name: "富邦華一銀行帳戶", amount: 293.4, currency: "CNY", type: "cash", category: "現金與帳戶" },
            { id: 'asset-8', name: "台新RICHART帳戶", amount: 1190, currency: "TWD", type: "cash", category: "現金與帳戶" },
            { id: 'asset-9', name: "台新薪轉帳戶", amount: 127388, currency: "TWD", type: "cash", category: "現金與帳戶" },
            { id: 'asset-12', name: "玉山數位帳戶", amount: 0, currency: "TWD", type: "cash", category: "現金與帳戶" },
            { id: 'asset-13', name: "國泰cube帳戶", amount: 0, currency: "TWD", type: "cash", category: "現金與帳戶" },
            { id: 'asset-14', name: "星展銀行帳戶", amount: 0, currency: "TWD", type: "cash", category: "現金與帳戶" },
            { id: 'asset-15', name: "聯邦newnewbank帳戶", amount: 0, currency: "TWD", type: "cash", category: "現金與帳戶" },
            { id: 'asset-10', name: "永豐大戶投(台股)", amount: 0, currency: "TWD", type: "investment", category: "證券戶" }, 
            { id: 'asset-11', name: "國泰證券(美股)", amount: 0, currency: "USD", type: "investment", category: "證券戶" }, 
            { id: 'asset-16', name: "國泰證券(台股)", amount: 0, currency: "TWD", type: "investment", category: "證券戶" },
        ];
        
        const INITIAL_STOCKS = [
            { id: 's1', code: '006208', name: '富邦台50', shares: 1850, cost: 90.97, currency: 'TWD', account: '永豐大戶投(台股)', currentPrice: 110.0 },
            { id: 's2', code: '00878', name: '國泰永續高股息', shares: 4000, cost: 18.77, currency: 'TWD', account: '永豐大戶投(台股)', currentPrice: 22.5 },
            { id: 's3', code: '2330', name: '台積電', shares: 70, cost: 1017.29, currency: 'TWD', account: '永豐大戶投(台股)', currentPrice: 1050.0 },
            { id: 's4', code: '2474', name: '可成', shares: 200, cost: 208.00, currency: 'TWD', account: '永豐大戶投(台股)', currentPrice: 210.0 },
            { id: 's5', code: 'QQQ', name: 'Invesco QQQ', shares: 2.21135, cost: 543.11, currency: 'USD', account: '國泰證券(美股)', currentPrice: 550.0 },
            { id: 's6', code: 'VTI', name: 'Vanguard Total Stock', shares: 3.95795, cost: 303.44, currency: 'USD', account: '國泰證券(美股)', currentPrice: 310.0 }
        ];

        const JOINT_ACCOUNT_INITIAL = { id: 'joint-0', name: "共同帳戶", amount: 0, currency: "TWD", type: "joint", category: "共同帳戶" };

        const FIXED_EXPENSES_DEFAULT = [
            { name: "Iphone17分期(至115年9月)", amount: 2491, currency: "TWD"},
            { name: "公益捐款", amount: 300, currency: "TWD"},
            { name: "孝親費", amount: 8000, currency: "TWD"},
            { name: "訂閱", amount: 610, currency: "TWD"},
            { name: "手機費", amount: 799, currency: "TWD"},
            { name: "定期定額美股(國泰證券)", amount: 240.2, currency: "USD"},
            { name: "共同帳戶存入款項", amount: 10000, currency: "TWD"}, 
        ];

        const FLUID_EXPENSES = [
            { name: "零用金", amount: 10000, currency: "TWD"},
            { name: "備用金額", amount: 10000, currency: "TWD"},
        ];

        // --- 全域狀態 ---
        let appData = {
            accounts: [], // 存放帳戶定義
            assets: [], // 存放計算後的資產狀態
            stocks: [], 
            creditCards: [], // 存放信用卡定義
            jointAccount: JOINT_ACCOUNT_INITIAL,
            transactions: [],
            exchangeRates: { TWD: 1, USD: 32.0, CNY: 4.4 },
            monthlyIncome: 50000, 
            fixedExpenses: [] 
        };
        
        let showFullHistory = false;
        let transactionToDeleteId = null;

        // --- 工具函數 ---
        function showAlert(message, type = 'info') {
            const typeMap = {
                success: { bgColor: 'bg-green-500', icon: 'fas fa-check-circle' },
                danger: { bgColor: 'bg-red-500', icon: 'fas fa-times-circle' },
                warning: { bgColor: 'bg-yellow-500', icon: 'fas fa-exclamation-triangle' },
                info: { bgColor: 'bg-blue-500', icon: 'fas fa-info-circle' },
            };
            const { bgColor, icon } = typeMap[type] || typeMap.info;
            const modalId = `modal-${Date.now()}`;
            const modalHtml = `
                <div id="${modalId}" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 transition-all duration-300 opacity-0 transform -translate-y-full">
                    <div class="flex items-center ${bgColor} text-white text-sm font-bold px-4 py-3 rounded-xl shadow-lg" role="alert">
                        <i class="${icon} mr-2"></i>
                        <p>${message}</p>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modalElement = document.getElementById(modalId);
            setTimeout(() => {
                modalElement.classList.remove('opacity-0', '-translate-y-full');
                modalElement.classList.add('opacity-100', 'translate-y-0');
            }, 10);
            setTimeout(() => {
                modalElement.classList.remove('opacity-100', 'translate-y-0');
                modalElement.classList.add('opacity-0', '-translate-y-full');
                setTimeout(() => modalElement.remove(), 300);
            }, 3000);
        }

        function formatCurrency(amount, currency) {
            const fractionDigits = (currency === 'USD' || currency === 'CNY') ? 2 : 0;
            return new Intl.NumberFormat('zh-TW', {
                style: 'decimal',
                minimumFractionDigits: fractionDigits,
                maximumFractionDigits: fractionDigits
            }).format(amount);
        }

        function convertToTWD(amount, currency) {
            const rate = appData.exchangeRates[currency] || 1;
            return amount * rate;
        }

        function calculateTotalAsset() {
            let totalTWD = 0;
            appData.assets.forEach(asset => {
                totalTWD += convertToTWD(asset.amount, asset.currency);
            });
            return totalTWD;
        }
        
        function getAccountByName(accountName) {
            const allAccounts = [...appData.assets, appData.jointAccount];
            let account = allAccounts.find(a => a.name === accountName);
            if (!account) {
                const creditCard = appData.creditCards.find(c => c.name === accountName);
                if (creditCard) {
                    return { name: creditCard.name, currency: creditCard.currency, type: 'credit_card' };
                }
            }
            return account;
        }

        async function fetchExchangeRates() {
            try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                if (!response.ok) throw new Error('API request failed');
                const data = await response.json();
                const rateUSD = data.rates.TWD;
                const rateCNY = data.rates.TWD / data.rates.CNY;
                if (rateUSD && rateCNY) {
                    appData.exchangeRates.USD = parseFloat(rateUSD.toFixed(2));
                    appData.exchangeRates.CNY = parseFloat(rateCNY.toFixed(2));
                    saveData();
                    renderAssets(); 
                }
            } catch (error) {
                console.error("匯率更新失敗", error);
            }
        }

        // --- LocalStorage 數據管理 ---

        function loadData() {
            try {
                const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    appData.transactions = parsedData.transactions || [];
                    appData.exchangeRates = parsedData.exchangeRates || appData.exchangeRates;
                    appData.jointAccount = parsedData.jointAccount || JOINT_ACCOUNT_INITIAL;
                    appData.monthlyIncome = parsedData.monthlyIncome || 50000;
                    appData.fixedExpenses = parsedData.fixedExpenses || JSON.parse(JSON.stringify(FIXED_EXPENSES_DEFAULT));
                    appData.stocks = parsedData.stocks || JSON.parse(JSON.stringify(INITIAL_STOCKS));
                    
                    // 載入自定義帳戶與信用卡，若無則使用預設
                    appData.accounts = parsedData.accounts || JSON.parse(JSON.stringify(STATIC_ASSETS));
                    appData.creditCards = parsedData.creditCards || JSON.parse(JSON.stringify(CREDIT_CARDS_INITIAL));

                    // 名稱遷移邏輯
                    const nameMapping = {
                        "永豐大戶投": "永豐大戶投(台股)",
                        "國泰證券": "國泰證券(美股)"
                    };
                    if (appData.stocks) {
                        appData.stocks.forEach(s => {
                            if (nameMapping[s.account]) s.account = nameMapping[s.account];
                        });
                    }
                    if (appData.transactions) {
                        appData.transactions.forEach(t => {
                            if (nameMapping[t.account]) t.account = nameMapping[t.account];
                            if (t.toAccount && nameMapping[t.toAccount]) t.toAccount = nameMapping[t.toAccount];
                        });
                    }

                } else {
                    appData.fixedExpenses = JSON.parse(JSON.stringify(FIXED_EXPENSES_DEFAULT));
                    appData.stocks = JSON.parse(JSON.stringify(INITIAL_STOCKS));
                    appData.accounts = JSON.parse(JSON.stringify(STATIC_ASSETS));
                    appData.creditCards = JSON.parse(JSON.stringify(CREDIT_CARDS_INITIAL));
                }
                
                applyTransactionsToAssets();

            } catch (e) {
                console.error("載入 LocalStorage 失敗:", e);
                // Fallback
                appData.accounts = JSON.parse(JSON.stringify(STATIC_ASSETS));
                appData.creditCards = JSON.parse(JSON.stringify(CREDIT_CARDS_INITIAL));
                appData.assets = JSON.parse(JSON.stringify(STATIC_ASSETS));
                appData.fixedExpenses = JSON.parse(JSON.stringify(FIXED_EXPENSES_DEFAULT));
                appData.stocks = JSON.parse(JSON.stringify(INITIAL_STOCKS));
            }
        }
        
        function applyTransactionsToAssets() {
            // 1. 使用 accounts 定義來初始化 assets 狀態 (重置金額)
            // 這裡我們假設 accounts 列表中的 amount 是初始值 (通常是0或手動設定的起始值)
            // 為了簡化，每次重算都先複製一份 accounts
            appData.assets = JSON.parse(JSON.stringify(appData.accounts));
            appData.jointAccount = JSON.parse(JSON.stringify(JOINT_ACCOUNT_INITIAL));
            
            // 2. 應用交易紀錄
            const allAccountsTemp = [...appData.assets, appData.jointAccount];

            appData.transactions.forEach(t => {
                const account = allAccountsTemp.find(a => a.name === t.account);
                let toAccount = null;
                if (t.type === 'transfer' && t.toAccount) {
                    toAccount = allAccountsTemp.find(a => a.name === t.toAccount);
                }

                if (account) {
                    let amountInAccountCurrency = t.amount;
                    if (t.currency !== account.currency) {
                        const TWD_Value = convertToTWD(t.amount, t.currency);
                        const accountRate = appData.exchangeRates[account.currency] || 1;
                        amountInAccountCurrency = TWD_Value / accountRate;
                    }

                    if (t.type === 'expense') {
                        account.amount -= amountInAccountCurrency;
                    } else if (t.type === 'income') {
                        account.amount += amountInAccountCurrency;
                    } else if (t.type === 'transfer') {
                         account.amount -= amountInAccountCurrency;
                    }
                }
                
                if (t.type === 'transfer' && toAccount) {
                     const TWD_Value = convertToTWD(t.amount, t.currency);
                     const toAccountRate = appData.exchangeRates[toAccount.currency] || 1;
                     const amountInToAccountCurrency = TWD_Value / toAccountRate;
                     toAccount.amount += amountInToAccountCurrency;
                }
            });
            
            const jointUpdated = allAccountsTemp.find(a => a.name === JOINT_ACCOUNT_INITIAL.name);
            if (jointUpdated) {
                appData.jointAccount = jointUpdated;
            }
            
            // 3. 將股票市值加總到對應的證券戶
            appData.stocks.forEach(stock => {
                const targetAsset = appData.assets.find(a => a.name === stock.account);
                if (targetAsset) {
                    const stockValue = stock.shares * stock.currentPrice; 
                    targetAsset.amount += stockValue; 
                }
            });

            // 4. 格式修正
            appData.assets.forEach(asset => {
                const fraction = (asset.currency === 'USD' || asset.currency === 'CNY') ? 2 : 0;
                asset.amount = parseFloat(asset.amount.toFixed(fraction));
            });
            appData.jointAccount.amount = parseFloat(appData.jointAccount.amount.toFixed(0));
        }

        function saveData() {
            try {
                const dataToSave = {
                    transactions: appData.transactions,
                    exchangeRates: appData.exchangeRates,
                    jointAccount: appData.jointAccount, 
                    monthlyIncome: appData.monthlyIncome,
                    fixedExpenses: appData.fixedExpenses,
                    stocks: appData.stocks,
                    accounts: appData.accounts, // 儲存自定義帳戶
                    creditCards: appData.creditCards // 儲存自定義信用卡
                };
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
            } catch (e) {
                console.error("保存 LocalStorage 失敗:", e);
                showAlert('warning', '資料保存失敗，請檢查瀏覽器設定。');
            }
        }

        // --- Tab 導航 (修復：補回 setupTabs 與 renderTabContent) ---
        function setupTabs() {
            const buttons = document.querySelectorAll('.nav-button');
            const contents = document.querySelectorAll('.tab-content');
            
            function switchTab(targetId) {
                buttons.forEach(btn => {
                    const isActive = btn.dataset.tab === targetId;
                    btn.classList.toggle('active', isActive);
                    btn.classList.toggle('text-gray-500', !isActive);
                    btn.classList.toggle('text-accent', isActive);
                });
                
                contents.forEach(content => {
                    content.classList.toggle('hidden', content.id !== `${targetId}-tab`);
                });
                renderTabContent(targetId);
            }

            buttons.forEach(button => {
                button.addEventListener('click', () => switchTab(button.dataset.tab));
            });
            switchTab('assets');
        }

        function renderTabContent(tabId) {
            switch (tabId) {
                case 'assets':
                    renderAssets();
                    renderGoalTab();
                    break;
                case 'plan':
                    renderFixedPlan(); 
                    renderMonthlyBillDue(); 
                    renderCreditCardPrep(); 
                    break;
                case 'bookkeeping':
                    renderBookkeepingFormOptions();
                    initCategorySelects(); 
                    renderTransactionHistory();
                    renderMonthlyStats(); 
                    renderCurrentYearStats(); 
                    initHistoricalStats(); 
                    break;
                case 'joint':
                    renderJointAccount();
                    break;
                case 'goal':
                    renderGoalTab();
                    break;
            }
        }
        
        // --- 設定/帳戶管理 Modal 邏輯 ---
        function openSettingsModal() {
            document.getElementById('settings-modal').classList.remove('hidden');
            renderSettingsAccounts();
            renderSettingsCards();
            populateAccountDropdowns(); // 更新下拉選單
            switchSettingsTab('accounts');
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function switchSettingsTab(tabName) {
            document.querySelectorAll('.settings-tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                btn.classList.remove('text-primary', 'border-b-2', 'border-accent', 'font-bold');
                btn.classList.add('text-gray-400');
            });

            const targetContent = document.getElementById(`settings-${tabName}-tab`);
            targetContent.classList.remove('hidden');
            
            const activeBtn = document.querySelector(`.settings-tab-btn[data-target="settings-${tabName}-tab"]`);
            activeBtn.classList.remove('text-gray-400');
            activeBtn.classList.add('text-primary', 'border-b-2', 'border-accent', 'font-bold');
        }

        // 渲染帳戶列表 (設定頁面)
        function renderSettingsAccounts() {
            const list = document.getElementById('settings-account-list');
            list.innerHTML = '';
            appData.accounts.forEach((acc, index) => {
                list.innerHTML += `
                    <div class="flex justify-between items-center p-2 bg-white border border-gray-200 rounded">
                        <div class="text-sm">
                            <span class="font-bold text-primary block">${acc.name}</span>
                            <span class="text-xs text-gray-500">${acc.category} • ${acc.currency}</span>
                        </div>
                        <button onclick="deleteAccount(${index})" class="text-red-400 hover:text-red-600 px-2">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
            });
        }

        // 新增帳戶
        document.getElementById('add-account-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('new-account-name').value.trim();
            const currency = document.getElementById('new-account-currency').value;
            const type = document.getElementById('new-account-type').value;
            
            if(!name) return;
            
            // 檢查重複
            if(appData.accounts.some(a => a.name === name)) {
                showAlert('warning', '帳戶名稱已存在');
                return;
            }

            const category = type === 'investment' ? '證券戶' : '現金與帳戶';
            const newAcc = {
                id: 'acc-' + Date.now(),
                name,
                amount: 0, // 初始餘額
                currency,
                type,
                category
            };

            appData.accounts.push(newAcc);
            applyTransactionsToAssets();
            saveData();
            
            renderSettingsAccounts();
            renderAssets(); // 更新主畫面
            renderBookkeepingFormOptions(); // 更新記帳選單
            populateAccountDropdowns(); // 新增：立即更新信用卡扣款帳戶的下拉選單
            showAlert('success', `已新增帳戶：${name}`);
            e.target.reset();
        });

        // 刪除帳戶
        function deleteAccount(index) {
            const accName = appData.accounts[index].name;
            if(confirm(`確定要刪除「${accName}」嗎？\n注意：相關的歷史交易紀錄仍會保留，但無法再選擇此帳戶。`)) {
                appData.accounts.splice(index, 1);
                applyTransactionsToAssets();
                saveData();
                renderSettingsAccounts();
                renderAssets();
                renderBookkeepingFormOptions();
                populateAccountDropdowns(); // 新增：刪除時也同步更新下拉選單，避免選到已刪除的帳戶
                showAlert('info', '帳戶已刪除');
            }
        }

        // 渲染信用卡列表 (設定頁面)
        function renderSettingsCards() {
            const list = document.getElementById('settings-card-list');
            list.innerHTML = '';
            appData.creditCards.forEach((card, index) => {
                list.innerHTML += `
                    <div class="flex justify-between items-center p-2 bg-white border border-gray-200 rounded">
                        <div class="text-sm">
                            <span class="font-bold text-primary block">${card.name}</span>
                            <span class="text-xs text-gray-500">扣款: ${card.linkedAccount} • 結帳${card.billingDay}日 • 繳款${card.paymentDay}日</span>
                        </div>
                        <button onclick="deleteCard(${index})" class="text-red-400 hover:text-red-600 px-2">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
            });
        }

        // 填充新增卡片時的扣款帳戶選單
        function populateAccountDropdowns() {
            const select = document.getElementById('new-card-linked');
            select.innerHTML = '<option value="" disabled selected>選擇扣款帳戶</option>';
            appData.accounts.forEach(acc => {
                select.innerHTML += `<option value="${acc.name}">${acc.name}</option>`;
            });
        }

        // 新增信用卡
        document.getElementById('add-card-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('new-card-name').value.trim();
            const linkedAccount = document.getElementById('new-card-linked').value;
            const billingDay = parseInt(document.getElementById('new-card-billing').value);
            const paymentDay = parseInt(document.getElementById('new-card-payment').value);

            if(!name || !linkedAccount) return;

            if(appData.creditCards.some(c => c.name === name)) {
                showAlert('warning', '卡片名稱已存在');
                return;
            }

            const newCard = {
                id: 'card-' + Date.now(),
                name,
                currency: 'TWD', // 預設台幣卡
                linkedAccount,
                billingDay,
                paymentDay
            };

            appData.creditCards.push(newCard);
            saveData();
            
            renderSettingsCards();
            renderCreditCardPrep(); // 更新理財規劃
            renderMonthlyBillDue(); // 更新帳單
            renderBookkeepingFormOptions(); // 更新記帳選單
            showAlert('success', `已新增卡片：${name}`);
            e.target.reset();
        });

        // 刪除信用卡
        function deleteCard(index) {
            const name = appData.creditCards[index].name;
            if(confirm(`確定要刪除「${name}」嗎？`)) {
                appData.creditCards.splice(index, 1);
                saveData();
                renderSettingsCards();
                renderCreditCardPrep();
                renderMonthlyBillDue();
                renderBookkeepingFormOptions();
                showAlert('info', '卡片已刪除');
            }
        }

        // --- 股票管理 Modal 邏輯 ---
        function openStockModal() {
            document.getElementById('stock-modal').classList.remove('hidden');
            renderStockUpdateList();
            renderTradeStockOptions();
            // 更新新增股票時的帳戶選單
            const stockAccSelect = document.getElementById('new-stock-account');
            stockAccSelect.innerHTML = '';
            // 只顯示 investment 類型的帳戶
            appData.accounts.filter(a => a.type === 'investment').forEach(acc => {
                stockAccSelect.innerHTML += `<option value="${acc.name}">${acc.name}</option>`;
            });
            
            switchStockTab('update');
        }

        function closeStockModal() {
            document.getElementById('stock-modal').classList.add('hidden');
        }

        function switchStockTab(tabName) {
            document.querySelectorAll('.stock-tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.stock-tab-btn').forEach(btn => {
                btn.classList.remove('text-primary', 'border-b-2', 'border-accent', 'font-bold');
                btn.classList.add('text-gray-400');
            });

            const targetContent = document.getElementById(`stock-${tabName}-tab`);
            targetContent.classList.remove('hidden');
            
            const activeBtn = document.querySelector(`.stock-tab-btn[data-target="stock-${tabName}-tab"]`);
            activeBtn.classList.remove('text-gray-400');
            activeBtn.classList.add('text-primary', 'border-b-2', 'border-accent', 'font-bold');
        }

        // 渲染更新股價列表
        function renderStockUpdateList() {
            const container = document.getElementById('stock-price-list');
            container.innerHTML = '';
            
            if (appData.stocks.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">目前沒有持股。</p>';
                return;
            }

            appData.stocks.forEach((stock, index) => {
                container.innerHTML += `
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <div class="flex justify-between mb-2">
                            <p class="font-bold text-primary">${stock.name} <span class="text-xs text-gray-500">(${stock.code})</span></p>
                            <p class="text-xs text-gray-500 bg-white px-2 py-1 rounded border border-gray-200">${stock.account}</p>
                        </div>
                        <div class="flex space-x-2 items-center">
                            <div class="flex-1">
                                <label class="text-[10px] text-gray-400 block mb-1">均價(成本)</label>
                                <div class="flex items-center">
                                    <span class="mr-1 text-[10px] text-gray-400">${stock.currency}</span>
                                    <input type="number" step="any" 
                                        class="w-full p-1.5 text-sm border rounded font-medium text-right focus:border-accent focus:ring-accent"
                                        value="${stock.cost}"
                                        onchange="updateTempStockCost(${index}, this.value)">
                                </div>
                            </div>
                            <div class="flex-1">
                                <label class="text-[10px] text-gray-400 block mb-1">收盤價(現價)</label>
                                <div class="flex items-center">
                                    <span class="mr-1 text-[10px] text-gray-400">${stock.currency}</span>
                                    <input type="number" step="any" 
                                        class="w-full p-1.5 text-sm border rounded font-bold text-right text-primary focus:border-accent focus:ring-accent"
                                        value="${stock.currentPrice}"
                                        onchange="updateTempStockPrice(${index}, this.value)">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function updateTempStockPrice(index, price) {
            appData.stocks[index].currentPrice = parseFloat(price);
        }

        function updateTempStockCost(index, cost) {
            appData.stocks[index].cost = parseFloat(cost);
        }

        function saveStockPrices() {
            applyTransactionsToAssets(); 
            saveData();
            renderAssets();
            renderGoalTab();
            closeStockModal();
            showAlert('success', '持股資料已更新，資產與損益已重新計算。');
        }

        function renderTradeStockOptions() {
            const select = document.getElementById('trade-stock-id');
            select.innerHTML = '';
            appData.stocks.forEach(stock => {
                const option = document.createElement('option');
                option.value = stock.id;
                option.textContent = `${stock.code} ${stock.name} (${stock.account})`;
                select.appendChild(option);
            });
        }

        document.getElementById('stock-add-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const code = document.getElementById('new-stock-code').value;
            const name = document.getElementById('new-stock-name').value;
            const account = document.getElementById('new-stock-account').value;
            const currency = document.getElementById('new-stock-currency').value;
            const shares = parseFloat(document.getElementById('new-stock-shares').value);
            const cost = parseFloat(document.getElementById('new-stock-cost').value);

            if (shares < 0 || cost < 0) {
                showAlert('warning', '數值不能為負數');
                return;
            }

            const newStock = {
                id: 'stock-' + Date.now(),
                code, name, account, currency,
                shares: shares,
                cost: cost, 
                currentPrice: cost 
            };
            appData.stocks.push(newStock);
            
            applyTransactionsToAssets();
            saveData();
            renderAssets();
            renderGoalTab();
            closeStockModal();
            showAlert('success', `已新增股票：${name}`);
            e.target.reset();
        });

        document.getElementById('stock-trade-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const action = document.getElementById('trade-action').value;
            const shares = parseFloat(document.getElementById('trade-shares').value);
            const price = parseFloat(document.getElementById('trade-price').value);

            if (shares <= 0 || price <= 0) {
                showAlert('warning', '股數與價格必須大於0');
                return;
            }

            const stockId = document.getElementById('trade-stock-id').value;
            const stock = appData.stocks.find(s => s.id === stockId);
            
            if (!stock) {
                showAlert('warning', '請選擇股票');
                return;
            }

            if (action === 'buy') {
                const totalCostOld = stock.shares * stock.cost;
                const totalCostNew = shares * price;
                const newTotalShares = stock.shares + shares;
                stock.cost = (totalCostOld + totalCostNew) / newTotalShares;
                stock.shares = newTotalShares;
                stock.currentPrice = price; 
                showAlert('success', `已加碼 ${stock.name} ${shares}股`);

            } else if (action === 'sell') {
                if (shares > stock.shares) {
                    showAlert('warning', '賣出股數大於持有股數');
                    return;
                }
                stock.shares -= shares;
                stock.currentPrice = price;
                
                if (stock.shares === 0) {
                     showAlert('info', `${stock.name} 已全數賣出`);
                } else {
                     showAlert('success', `已賣出 ${stock.name} ${shares}股`);
                }
            }
            
            applyTransactionsToAssets();
            saveData();
            renderAssets();
            renderGoalTab();
            closeStockModal();
            e.target.reset();
        });


        // --- Tab 1: 資產分配 ---
        function renderAssets() {
            const container = document.getElementById('asset-accordion');
            const totalTWD = calculateTotalAsset(); 
            
            document.getElementById('total-asset-twd').textContent = `TWD ${formatCurrency(totalTWD, 'TWD')}`;
            document.getElementById('exchange-rate-display').textContent = `匯率更新：USD=${appData.exchangeRates.USD}, CNY=${appData.exchangeRates.CNY}`;

            let totalPL = 0;
            appData.stocks.forEach(s => {
                const marketVal = s.shares * s.currentPrice;
                const costVal = s.shares * s.cost;
                const pl = marketVal - costVal;
                totalPL += convertToTWD(pl, s.currency);
            });
            const plEl = document.getElementById('total-unrealized-pl');
            const plColor = totalPL >= 0 ? 'text-red-300' : 'text-green-300';
            plEl.innerHTML = `
                <span>證券未實現損益:</span>
                <span class="font-bold ${plColor} text-lg">${totalPL > 0 ? '+' : ''}${formatCurrency(totalPL, 'TWD')}</span>
            `;

            container.innerHTML = '';
            
            const groupedAssets = appData.assets.reduce((acc, asset) => {
                acc[asset.category] = acc[asset.category] || [];
                acc[asset.category].push(asset);
                return acc;
            }, {});
            
            Object.entries(groupedAssets).forEach(([category, assets]) => {
                const categoryTotalTWD = assets.reduce((sum, a) => sum + convertToTWD(a.amount, a.currency), 0);
                const categoryId = `accordion-${category.replace(/\s/g, '-')}`;
                const isOpen = DEFAULT_OPEN_CATEGORIES.includes(categoryId);
                const contentClass = isOpen ? '' : 'hidden';
                const iconClass = isOpen ? 'rotate-180' : '';

                let innerContent = '';
                
                assets.forEach(asset => {
                    let stockDetailsHtml = '';
                    
                    if (asset.type === 'investment') {
                        const accountStocks = appData.stocks.filter(s => s.account === asset.name && s.shares > 0);
                        if (accountStocks.length > 0) {
                            stockDetailsHtml = `
                                <div class="bg-gray-50 p-2 text-xs border-t border-gray-100">
                                    <table class="w-full text-center">
                                        <thead class="text-gray-400 border-b border-gray-200">
                                            <tr>
                                                <th class="py-1 text-left">標的</th>
                                                <th class="py-1">現價/成本</th>
                                                <th class="py-1">市值</th>
                                                <th class="py-1">損益</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${accountStocks.map(s => {
                                                const mktVal = s.shares * s.currentPrice;
                                                const costVal = s.shares * s.cost;
                                                const pl = mktVal - costVal;
                                                const plPercent = ((pl / costVal) * 100).toFixed(1);
                                                const plClass = pl >= 0 ? 'text-red-600' : 'text-green-600';
                                                
                                                return `
                                                <tr class="border-b border-gray-100 last:border-0">
                                                    <td class="py-2 text-left">
                                                        <div class="font-bold text-gray-700">${s.name}</div>
                                                        <div class="text-[10px] text-gray-400">${s.code} • ${s.shares}股</div>
                                                    </td>
                                                    <td class="py-2">
                                                        <div class="font-medium">${formatCurrency(s.currentPrice, s.currency)}</div>
                                                        <div class="text-[10px] text-gray-400">${formatCurrency(s.cost, s.currency)}</div>
                                                    </td>
                                                    <td class="py-2 font-medium">
                                                        ${formatCurrency(mktVal, s.currency)}
                                                    </td>
                                                    <td class="py-2">
                                                        <div class="${plClass} font-bold">${pl>0?'+':''}${formatCurrency(pl, s.currency)}</div>
                                                        <div class="${plClass} text-[10px]">${plPercent}%</div>
                                                    </td>
                                                </tr>`;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `;
                        }
                    }

                    innerContent += `
                        <div class="border-t border-base/50">
                            <div class="flex justify-between items-center p-3 text-sm hover:bg-secondary/50">
                                <span class="ml-4 font-medium text-gray-700">${asset.name}</span>
                                <span class="font-bold text-primary">
                                    ${formatCurrency(asset.amount, asset.currency)} <span class="text-xs text-gray-500 font-normal">${asset.currency}</span>
                                </span>
                            </div>
                            ${stockDetailsHtml}
                        </div>
                    `;
                });

                const categoryHeader = `
                    <div class="bg-white rounded-xl shadow-md border border-base">
                        <button class="w-full flex justify-between items-center p-4 font-semibold text-lg text-primary" onclick="toggleAccordion('${categoryId}')">
                            <span>${category} (${assets.length})</span>
                            <div class="text-right">
                                <span class="text-sm font-bold text-accent">TWD ${formatCurrency(categoryTotalTWD, 'TWD')}</span>
                                <i class="fas fa-chevron-down text-sm ml-3 transition-transform duration-300 transform ${iconClass}" id="${categoryId}-icon"></i>
                            </div>
                        </button>
                        <div id="${categoryId}" class="${contentClass}">
                            ${innerContent}
                        </div>
                    </div>
                `;
                container.innerHTML += categoryHeader;
            });
        }
        
        function updateMonthlyIncome(newVal) {
            const val = parseFloat(newVal);
            if (!isNaN(val) && val >= 0) {
                appData.monthlyIncome = val;
                saveData();
                renderFixedPlan();
            }
        }
        function updateFixedExpense(index, newVal) {
            const val = parseFloat(newVal);
            if (!isNaN(val) && val >= 0) {
                appData.fixedExpenses[index].amount = val;
                saveData();
                renderFixedPlan();
            }
        }
        function renderFixedPlan() {
            const fixedContainer = document.getElementById('fixed-expenses-list');
            const fluidContainer = document.getElementById('fluid-expenses-list');
            fixedContainer.innerHTML = '';
            fluidContainer.innerHTML = '';
            document.getElementById('monthly-income-input').value = appData.monthlyIncome;
            let totalFixedExpenseTWD = 0;
            appData.fixedExpenses.forEach((exp, index) => {
                const expenseTWD = convertToTWD(exp.amount, exp.currency);
                totalFixedExpenseTWD += expenseTWD;
                fixedContainer.innerHTML += `
                    <div class="flex justify-between items-center p-2 border-b last:border-b-0 border-base/50 text-base">
                        <span class="font-medium">${exp.name}</span>
                        <div class="flex items-center">
                            <span class="text-xs text-gray-500 mr-2">${exp.currency}</span>
                            <input type="number" 
                                   class="font-bold text-red-600 w-20 bg-transparent border-b border-dashed border-red-200 focus:outline-none focus:border-red-600 text-right"
                                   value="${exp.amount}"
                                   onchange="updateFixedExpense(${index}, this.value)">
                        </div>
                    </div>
                `;
            });
            FLUID_EXPENSES.forEach(exp => {
                let extraHtml = '';
                if (exp.name === '零用金') {
                    const { startDate, endDate } = getCurrentFinancialMonthRange();
                    let currentMonthCardSpending = 0;
                    appData.transactions.forEach(t => {
                        if (t.type === 'expense') {
                            const tDate = new Date(t.timestamp);
                            if (tDate >= startDate && tDate <= endDate) {
                                // 使用 appData.creditCards 來檢查
                                const isCard = appData.creditCards.some(c => c.name === t.account);
                                if (isCard) currentMonthCardSpending += convertToTWD(t.amount, t.currency);
                            }
                        }
                    });
                    const budget = convertToTWD(exp.amount, exp.currency);
                    const remaining = budget - currentMonthCardSpending;
                    const isOver = remaining < 0;
                    extraHtml = `
                        <div class="w-full text-xs mt-1 bg-gray-50 p-2 rounded">
                            <div class="flex justify-between mb-1">
                                <span class="text-gray-500">本月已刷卡</span>
                                <span class="font-bold text-red-500">-${formatCurrency(currentMonthCardSpending, 'TWD')}</span>
                            </div>
                            <div class="flex justify-between border-t border-gray-200 pt-1">
                                <span class="text-gray-500">剩餘額度</span>
                                <span class="font-bold ${isOver ? 'text-red-600' : 'text-green-600'}">
                                    ${formatCurrency(remaining, 'TWD')}
                                    ${isOver ? '(超支!)' : ''}
                                </span>
                            </div>
                        </div>
                    `;
                }
                fluidContainer.innerHTML += `
                    <div class="flex flex-col p-2 border-b last:border-b-0 border-base/50 text-base">
                        <div class="flex justify-between items-center w-full">
                            <span class="font-medium">${exp.name}</span>
                            <span class="font-bold text-green-600">
                                ${formatCurrency(exp.amount, exp.currency)} <span class="text-xs text-gray-500">${exp.currency}</span>
                            </span>
                        </div>
                        ${extraHtml}
                    </div>
                `;
            });
            document.getElementById('total-fixed-expense').textContent = `TWD ${formatCurrency(totalFixedExpenseTWD, 'TWD')}`;
        }
        
        function renderMonthlyBillDue() {
            const container = document.getElementById('bill-due-list');
            if(!container) return;
            container.innerHTML = '';
            
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth(); 

            // 使用 appData.creditCards
            const accountGroups = {};

            appData.creditCards.forEach(card => {
                let stmtDate = new Date(currentYear, currentMonth, card.billingDay, 23, 59, 59);
                let startDate = new Date(currentYear, currentMonth - 1, card.billingDay + 1, 0, 0, 0);

                let cardTotal = 0;
                appData.transactions.forEach(t => {
                    if (t.type === 'expense' && t.account === card.name) {
                        let tDate = new Date(t.timestamp);
                        if (tDate >= startDate && tDate <= stmtDate) {
                            cardTotal += convertToTWD(t.amount, t.currency);
                        }
                    }
                });

                if (cardTotal > 0) {
                    if (!accountGroups[card.linkedAccount]) {
                        accountGroups[card.linkedAccount] = {
                            total: 0,
                            cards: [],
                            paymentDay: card.paymentDay 
                        };
                    }
                    accountGroups[card.linkedAccount].total += cardTotal;
                    accountGroups[card.linkedAccount].cards.push({
                        name: card.name,
                        amount: cardTotal
                    });
                }
            });

            if (Object.keys(accountGroups).length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 text-xs py-2">本月尚無應繳帳單</p>';
                return;
            }

            for (const [accountName, group] of Object.entries(accountGroups)) {
                let payDate = new Date(currentYear, currentMonth, group.paymentDay);
                let payDateStr = `${payDate.getMonth()+1}/${payDate.getDate()}`;
                
                const cardsHtml = group.cards.map(c => 
                    `<div class="flex justify-between text-xs text-gray-500">
                        <span>${c.name}</span>
                        <span>$${formatCurrency(c.amount, 'TWD')}</span>
                    </div>`
                ).join('');

                container.innerHTML += `
                    <div class="bg-secondary/30 p-3 rounded-lg border border-base/50">
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <span class="font-bold text-primary block">${accountName}</span>
                                <span class="text-xs text-gray-500">建議繳款期限: ${payDateStr}</span>
                            </div>
                            <div class="text-right">
                                <span class="text-xs text-gray-500 block">總應繳金額</span>
                                <span class="font-bold text-red-600 text-lg">TWD ${formatCurrency(group.total, 'TWD')}</span>
                            </div>
                        </div>
                        <div class="pl-2 border-l-2 border-base space-y-1 mt-2 pt-2 border-t border-gray-200/50">
                            ${cardsHtml}
                        </div>
                    </div>
                `;
            }
        }

        function renderBookkeepingFormOptions() {
            const select = document.getElementById('transaction-account');
            select.innerHTML = '<option value="" disabled selected>選擇帳戶/卡片</option>';
            const groupAccounts = document.createElement('optgroup');
            groupAccounts.label = "帳戶";
            const allAccounts = [...appData.assets, appData.jointAccount];
            allAccounts.forEach(asset => {
                const option = document.createElement('option');
                option.value = asset.name;
                option.textContent = `${asset.name} (${asset.currency})`;
                groupAccounts.appendChild(option);
            });
            select.appendChild(groupAccounts);
            const groupCards = document.createElement('optgroup');
            groupCards.label = "信用卡";
            // 使用 appData.creditCards
            appData.creditCards.forEach(card => {
                const option = document.createElement('option');
                option.value = card.name;
                option.textContent = `${card.name} (${card.currency})`;
                groupCards.appendChild(option);
            });
            select.appendChild(groupCards);
        }
        function initCategorySelects() {
            const typeSelect = document.getElementById('transaction-type');
            const categorySelect = document.getElementById('transaction-category');
            const subcategorySelect = document.getElementById('transaction-subcategory');
            typeSelect.onchange = function() { updateCategoryOptions(); };
            categorySelect.onchange = function() {
                const type = typeSelect.value;
                const selectedCategory = this.value;
                if (type === 'transfer') return;
                subcategorySelect.innerHTML = '<option value="" disabled selected>細項</option>';
                if (type === 'expense') {
                     const subItems = EXPENSE_CATEGORIES[selectedCategory] || [];
                     subItems.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item;
                        option.textContent = item;
                        subcategorySelect.appendChild(option);
                    });
                    subcategorySelect.disabled = false;
                    subcategorySelect.classList.remove('bg-gray-100', 'text-gray-400');
                    subcategorySelect.classList.add('bg-white');
                }
            };
            updateCategoryOptions();
        }
        function updateCategoryOptions() {
            const typeSelect = document.getElementById('transaction-type');
            const categorySelect = document.getElementById('transaction-category');
            const subcategorySelect = document.getElementById('transaction-subcategory');
            const rowAccountSelection = document.getElementById('row-account-selection');
            const accountSelect = document.getElementById('transaction-account');
            
            const type = typeSelect.value;
            categorySelect.innerHTML = '';
            subcategorySelect.innerHTML = '';

            if (type === 'expense') {
                categorySelect.appendChild(new Option("分類", "", true, true));
                categorySelect.options[0].disabled = true;
                subcategorySelect.appendChild(new Option("細項", "", true, true));
                subcategorySelect.options[0].disabled = true;
                Object.keys(EXPENSE_CATEGORIES).forEach(category => {
                    categorySelect.appendChild(new Option(category, category));
                });
                subcategorySelect.disabled = false;
                subcategorySelect.classList.remove('bg-gray-100', 'text-gray-400');
                subcategorySelect.classList.add('bg-white');
                rowAccountSelection.classList.remove('hidden');
                accountSelect.required = true;
            } else if (type === 'income') {
                categorySelect.appendChild(new Option("分類", "", true, true));
                categorySelect.options[0].disabled = true;
                subcategorySelect.appendChild(new Option("-", "-", true, true));
                INCOME_CATEGORIES_LIST.forEach(category => {
                    categorySelect.appendChild(new Option(category, category));
                });
                subcategorySelect.disabled = true;
                subcategorySelect.classList.remove('bg-white');
                subcategorySelect.classList.add('bg-gray-100', 'text-gray-400');
                rowAccountSelection.classList.remove('hidden');
                accountSelect.required = true;
            } else if (type === 'transfer') {
                categorySelect.appendChild(new Option("轉出帳號", "", true, true));
                categorySelect.options[0].disabled = true;
                subcategorySelect.appendChild(new Option("轉入帳號", "", true, true));
                subcategorySelect.options[0].disabled = true;
                const allAccounts = [...appData.assets, appData.jointAccount];
                allAccounts.forEach(asset => {
                    const displayText = `${asset.name} (${asset.currency})`;
                    categorySelect.appendChild(new Option(displayText, asset.name));
                    subcategorySelect.appendChild(new Option(displayText, asset.name));
                });
                subcategorySelect.disabled = false;
                subcategorySelect.classList.remove('bg-gray-100', 'text-gray-400');
                subcategorySelect.classList.add('bg-white');
                rowAccountSelection.classList.add('hidden');
                accountSelect.required = false;
            }
        }
        function getTodayDateString() {
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }
        function setTransactionDateDefault() {
            const dateInput = document.getElementById('transaction-date');
            if (dateInput) dateInput.value = getTodayDateString();
        }
        const transactionForm = document.getElementById('transaction-form');
        if (transactionForm) {
            transactionForm.addEventListener('submit', handleTransactionSubmit);
        }
        function handleTransactionSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const dateStr = document.getElementById('transaction-date').value;
            const type = document.getElementById('transaction-type').value; 
            const category = document.getElementById('transaction-category').value; 
            const subcategory = document.getElementById('transaction-subcategory').value; 
            const amount = parseFloat(form.elements['transaction-amount'].value);
            const currency = form.elements['transaction-currency'].value;
            const accountName = form.elements['transaction-account'].value;
            const note = document.getElementById('transaction-note').value;
            
            if (!dateStr || isNaN(amount) || amount <= 0) { showAlert('warning', '輸入無效'); return; }
            if (category === "" && type !== 'income') { showAlert('warning', '請選擇分類'); return; }
            if (type === 'expense' && subcategory === "") { showAlert('warning', '請選擇細項'); return; }
            
            let name = "";
            let finalAccount = "";
            let toAccount = null;

            if (type === 'expense') {
                name = `${category}-${subcategory}`;
                finalAccount = accountName;
            } else if (type === 'income') {
                name = category; 
                finalAccount = accountName;
            } else if (type === 'transfer') {
                name = "轉帳"; 
                finalAccount = category; 
                toAccount = subcategory; 
            }
            const [y, m, d] = dateStr.split('-').map(Number);
            const timestampDate = new Date(y, m - 1, d, 12, 0, 0); 
            saveNewTransaction(name, amount, currency, type, finalAccount, toAccount, note, timestampDate.getTime());
            form.reset();
            setTransactionDateDefault();
            if(type === 'transfer') document.getElementById('transaction-type').value = 'expense';
            updateCategoryOptions(); 
        }
        function saveNewTransaction(name, amount, currency, type, accountName, toAccount, note, timestamp) {
            const newTransaction = {
                id: Date.now().toString(),
                name, amount: parseFloat(amount), currency, type, account: accountName, toAccount, timestamp: timestamp || Date.now(), note: note || '' 
            };
            appData.transactions.push(newTransaction);
            applyTransactionsToAssets();
            saveData();
            showAlert('success', '紀錄成功');
            renderTransactionHistory();
            renderAssets(); 
            renderJointAccount(); 
            renderGoalTab(); 
            renderMonthlyStats(); 
            renderCurrentYearStats();
            initHistoricalStats(); 
            renderCreditCardPrep();
            renderMonthlyBillDue(); // 更新本月帳單
            renderFixedPlan(); 
        }
        function renderTransactionHistory() {
            const historyList = document.getElementById('transaction-history');
            const loadMoreBtn = document.getElementById('load-more-container');
            historyList.innerHTML = '';
            if (appData.transactions.length === 0) {
                historyList.innerHTML = '<li class="text-center text-gray-500 p-4 rounded-xl">尚無記帳歷史記錄。</li>';
                loadMoreBtn.classList.add('hidden');
                return;
            }
            const sortedTransactions = [...appData.transactions].sort((a, b) => b.timestamp - a.timestamp);
            const displayLimit = showFullHistory ? sortedTransactions.length : 10;
            const transactionsToShow = sortedTransactions.slice(0, displayLimit);
            historyList.innerHTML = transactionsToShow.map(t => {
                let color, sign, icon, displayAccount;
                if (t.type === 'expense') {
                    color = 'text-red-600'; sign = '-'; icon = 'fa-arrow-circle-down'; displayAccount = t.account;
                } else if (t.type === 'income') {
                    color = 'text-green-600'; sign = '+'; icon = 'fa-arrow-circle-up'; displayAccount = t.account;
                } else if (t.type === 'transfer') {
                    color = 'text-blue-600'; sign = ''; icon = 'fa-exchange-alt'; displayAccount = `${t.account} <i class="fas fa-arrow-right text-xs mx-1"></i> ${t.toAccount}`;
                }
                const dateStr = new Date(t.timestamp).toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
                const noteHtml = t.note ? `<p class="text-xs text-gray-400 mt-0.5 truncate"><i class="fas fa-sticky-note mr-1"></i>${t.note}</p>` : '';
                return `
                    <li class="bg-secondary/20 p-3 rounded-lg flex justify-between items-center border border-transparent hover:border-base transition">
                        <div class="flex items-center min-w-0 flex-1">
                            <i class="fas ${icon} text-lg ${color} mr-3"></i>
                            <div class="min-w-0 flex-1">
                                <p class="font-medium truncate text-primary text-sm">${t.name}</p>
                                <p class="text-xs text-gray-500 mt-0.5 truncate">${displayAccount}</p>
                                ${noteHtml}
                            </div>
                        </div>
                        <div class="text-right ml-2 flex flex-col items-end">
                            <p class="font-bold text-base ${color}">
                                <span class="text-xs text-gray-400 mr-1 font-normal">${dateStr}</span>${sign}${formatCurrency(t.amount, t.currency)}
                            </p>
                            <div class="mt-1 flex space-x-2">
                                <button onclick="event.stopPropagation(); openDeleteModal('${t.id}')" class="text-gray-400 hover:text-red-500 transition px-2"><i class="fas fa-trash-alt text-xs"></i></button>
                                <button onclick="openEditModal('${t.id}')" class="text-gray-400 hover:text-accent transition px-2"><i class="fas fa-edit text-xs"></i></button>
                            </div>
                        </div>
                    </li>
                `;
            }).join('');
            if (sortedTransactions.length > 10 && !showFullHistory) loadMoreBtn.classList.remove('hidden'); else loadMoreBtn.classList.add('hidden');
        }
        function loadMoreTransactions() { showFullHistory = true; renderTransactionHistory(); }
        function openEditModal(id) {
            const t = appData.transactions.find(item => item.id === id);
            if (!t) return;
            document.getElementById('edit-id').value = t.id;
            document.getElementById('edit-amount').value = t.amount;
            document.getElementById('edit-note').value = t.note || '';
            const date = new Date(t.timestamp);
            document.getElementById('edit-date').value = date.toISOString().split('T')[0];
            document.getElementById('edit-modal').classList.remove('hidden');
        }
        function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); }
        document.getElementById('edit-transaction-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const newAmount = parseFloat(document.getElementById('edit-amount').value);
            const newDateStr = document.getElementById('edit-date').value;
            const newNote = document.getElementById('edit-note').value;
            const tIndex = appData.transactions.findIndex(item => item.id === id);
            if (tIndex > -1) {
                appData.transactions[tIndex].amount = newAmount;
                appData.transactions[tIndex].note = newNote;
                const newDate = new Date(newDateStr); newDate.setHours(12, 0, 0, 0);
                appData.transactions[tIndex].timestamp = newDate.getTime();
                applyTransactionsToAssets(); saveData(); renderTransactionHistory(); renderAssets(); renderJointAccount(); renderGoalTab(); renderMonthlyStats(); renderCurrentYearStats(); renderCreditCardPrep(); renderMonthlyBillDue(); renderFixedPlan();
                closeEditModal(); showAlert('success', '紀錄修改成功！');
            }
        });
        function openDeleteModal(id) { transactionToDeleteId = id; document.getElementById('delete-modal').classList.remove('hidden'); }
        function closeDeleteModal() { document.getElementById('delete-modal').classList.add('hidden'); transactionToDeleteId = null; }
        function confirmDelete() {
            if (transactionToDeleteId) {
                const index = appData.transactions.findIndex(t => t.id === transactionToDeleteId);
                if (index > -1) {
                    appData.transactions.splice(index, 1);
                    applyTransactionsToAssets(); saveData(); renderTransactionHistory(); renderAssets(); renderJointAccount(); renderGoalTab(); renderMonthlyStats(); renderCurrentYearStats(); renderCreditCardPrep(); renderMonthlyBillDue(); renderFixedPlan();
                }
                closeDeleteModal(); showAlert('info', '記帳記錄已刪除。');
            }
        }
        function renderMonthlyStats() {
            const container = document.getElementById('monthly-stats-list');
            const totalExpenseEl = document.getElementById('stats-total-expense');
            const totalIncomeEl = document.getElementById('stats-total-income');
            const rangeEl = document.getElementById('stats-date-range');
            const { startDate, endDate } = getCurrentFinancialMonthRange();
            rangeEl.textContent = `統計區間: ${startDate.getMonth()+1}/${startDate.getDate()} ~ ${endDate.getMonth()+1}/${endDate.getDate()}`;
            const currentPeriodTransactions = appData.transactions.filter(t => {
                const tDate = new Date(t.timestamp);
                return tDate >= startDate && tDate <= endDate && t.type !== 'transfer' && t.account !== '共同帳戶';
            });
            let totalExpenseTWD = 0, totalIncomeTWD = 0; const accountStats = {};
            currentPeriodTransactions.forEach(t => {
                const amountTWD = convertToTWD(t.amount, t.currency);
                if (t.type === 'expense') {
                    totalExpenseTWD += amountTWD;
                    if (!accountStats[t.account]) accountStats[t.account] = 0;
                    accountStats[t.account] += amountTWD;
                } else if (t.type === 'income') totalIncomeTWD += amountTWD;
            });
            totalExpenseEl.textContent = `TWD ${formatCurrency(totalExpenseTWD, 'TWD')}`;
            totalIncomeEl.textContent = `TWD ${formatCurrency(totalIncomeTWD, 'TWD')}`;
            container.innerHTML = '';
            if (Object.keys(accountStats).length === 0) { container.innerHTML = '<p class="text-center text-gray-500 text-sm py-2">本週期尚無個人支出紀錄。</p>'; return; }
            const sortedStats = Object.entries(accountStats).sort((a, b) => b[1] - a[1]);
            sortedStats.forEach(([name, amount]) => {
                const percent = totalExpenseTWD > 0 ? ((amount / totalExpenseTWD) * 100).toFixed(1) : 0;
                const isCredit = appData.creditCards.some(c => c.name === name);
                const iconClass = isCredit ? 'fa-credit-card text-blue-500' : 'fa-wallet text-amber-600';
                container.innerHTML += `
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center space-x-2 w-1/2">
                            <i class="fas ${iconClass} w-5 text-center"></i>
                            <span class="truncate text-primary font-medium" title="${name}">${name}</span>
                        </div>
                        <div class="text-right w-1/2">
                            <span class="font-bold text-gray-700">TWD ${formatCurrency(amount, 'TWD')}</span>
                            <span class="text-xs text-gray-400 ml-1">(${percent}%)</span>
                        </div>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-1.5 mt-1">
                        <div class="bg-primary h-1.5 rounded-full opacity-60" style="width: ${percent}%"></div>
                    </div>
                `;
            });
        }
        function getMonthlyStatsForYear(year) {
            const monthlyData = Array(12).fill(null).map(() => ({ income: 0, expense: 0 }));
            appData.transactions.forEach(t => {
                if (t.type === 'transfer' || t.account === '共同帳戶') return;
                const date = new Date(t.timestamp);
                if (date.getFullYear() === parseInt(year)) {
                    const monthIndex = date.getMonth();
                    const amountTWD = convertToTWD(t.amount, t.currency);
                    if (t.type === 'income') monthlyData[monthIndex].income += amountTWD;
                    else if (t.type === 'expense') monthlyData[monthIndex].expense += amountTWD;
                }
            });
            return monthlyData;
        }
        function renderCurrentYearStats() {
            const currentYear = new Date().getFullYear();
            const container = document.getElementById('yearly-stats-container');
            const data = getMonthlyStatsForYear(currentYear);
            container.innerHTML = '';
            let hasData = false;
            data.forEach((monthData, index) => {
                const income = monthData.income; const expense = monthData.expense; const net = income - expense; const hasActivity = income > 0 || expense > 0;
                if (hasActivity) hasData = true;
                const opacityClass = hasActivity ? 'opacity-100' : 'opacity-40';
                container.innerHTML += `
                    <div class="flex justify-between items-center text-sm border-b border-gray-100 pb-2 ${opacityClass}">
                        <div class="w-12 font-bold text-gray-500">${index + 1}月</div>
                        <div class="flex-1 px-2">
                             <div class="flex justify-between text-xs mb-1">
                                <span class="text-green-600">收入 ${formatCurrency(income, 'TWD')}</span>
                                <span class="text-red-600">支出 ${formatCurrency(expense, 'TWD')}</span>
                             </div>
                             <div class="h-1.5 w-full bg-gray-100 rounded-full flex overflow-hidden">
                                <div class="bg-green-500 h-full" style="width: ${income > 0 ? '50%' : '0%'}"></div>
                                <div class="bg-red-500 h-full" style="width: ${expense > 0 ? '50%' : '0%'}"></div>
                             </div>
                        </div>
                        <div class="w-20 text-right font-bold ${net >= 0 ? 'text-primary' : 'text-red-600'}">${net >= 0 ? '+' : ''}${formatCurrency(net, 'TWD')}</div>
                    </div>`;
            });
            if(!hasData) container.innerHTML = '<p class="text-center text-gray-400 text-sm py-4">本年度尚無紀錄</p>';
        }
        function initHistoricalStats() {
            const select = document.getElementById('history-year-select');
            const years = new Set();
            appData.transactions.forEach(t => years.add(new Date(t.timestamp).getFullYear()));
            years.add(new Date().getFullYear());
            const sortedYears = Array.from(years).sort((a, b) => b - a);
            select.innerHTML = '<option value="" disabled selected>請選擇</option>';
            sortedYears.forEach(year => select.appendChild(new Option(`${year}年`, year)));
            select.onchange = function() { renderHistoricalStats(this.value); };
        }
        function renderHistoricalStats(year) {
            const container = document.getElementById('history-year-stats-container');
            const data = getMonthlyStatsForYear(year);
            container.innerHTML = '';
            let hasData = false;
            data.forEach((monthData, index) => {
                if (monthData.income > 0 || monthData.expense > 0) {
                    hasData = true;
                    const net = monthData.income - monthData.expense;
                    container.innerHTML += `<div class="flex justify-between items-center text-sm border-b border-gray-100 pb-2"><div class="w-12 font-bold text-gray-500">${index + 1}月</div><div class="flex-1 px-4 text-center"><span class="block text-green-600 text-xs">收 ${formatCurrency(monthData.income, 'TWD')}</span><span class="block text-red-600 text-xs">支 ${formatCurrency(monthData.expense, 'TWD')}</span></div><div class="w-20 text-right font-bold ${net >= 0 ? 'text-primary' : 'text-red-600'}">${net >= 0 ? '結餘 +' : ''}${formatCurrency(net, 'TWD')}</div></div>`;
                }
            });
            if(!hasData) container.innerHTML = '<p class="text-center text-gray-400 text-sm py-4">該年度無紀錄</p>';
        }
        function renderGoalTab() {
            const totalAssetTWD = calculateTotalAsset(); 
            const difference = GOAL_AMOUNT - totalAssetTWD;
            const progressPercent = Math.min(100, (totalAssetTWD / GOAL_AMOUNT) * 100);
            const goalStatusEl = document.getElementById('goal-status');
            const progressBar = document.getElementById('goal-progress-bar');
            const percentDisplay = document.getElementById('goal-percent-display');
            progressBar.style.width = `${progressPercent}%`;
            percentDisplay.textContent = `${progressPercent.toFixed(2)}%`;
            if (difference > 0) {
                goalStatusEl.innerHTML = `<p class="text-xl text-primary font-medium mt-4">距離百萬目標</p><p class="text-3xl font-bold text-red-700 my-2 tracking-wider">TWD ${formatCurrency(difference, 'TWD')}</p><p class="text-sm text-gray-600">加油！持續增加資產累積。</p>`;
            } else {
                 goalStatusEl.innerHTML = `<p class="text-xl text-primary font-medium mt-4">恭喜您！已達成目標！</p><p class="text-3xl font-bold text-green-700 my-2 tracking-wider">超額達成 ${formatCurrency(Math.abs(difference), 'TWD')}</p><p class="text-sm text-gray-600">繼續保持，設定下一個里程碑！</p>`;
            }
        }
        function getCurrentFinancialMonthRange() {
            const now = new Date(); const day = now.getDate();
            let startDate, endDate;
            if (day >= 5) { startDate = new Date(now.getFullYear(), now.getMonth(), 5); endDate = new Date(now.getFullYear(), now.getMonth() + 1, 4, 23, 59, 59); } 
            else { startDate = new Date(now.getFullYear(), now.getMonth() - 1, 5); endDate = new Date(now.getFullYear(), now.getMonth(), 4, 23, 59, 59); }
            return { startDate, endDate };
        }
        function renderJointAccount() {
            const jointAmount = appData.jointAccount.amount;
            document.getElementById('joint-asset-twd').textContent = `TWD ${formatCurrency(jointAmount, 'TWD')}`;
            const { startDate, endDate } = getCurrentFinancialMonthRange(); 
            const periodTrans = appData.transactions.filter(t => new Date(t.timestamp) >= startDate && new Date(t.timestamp) <= endDate);
            const userContribution = periodTrans.filter(t => t.type === 'transfer' && t.toAccount === '共同帳戶').reduce((sum, t) => sum + convertToTWD(t.amount, t.currency), 0);
            const partnerContribution = periodTrans.filter(t => t.type === 'income' && t.account === '共同帳戶').reduce((sum, t) => sum + convertToTWD(t.amount, t.currency), 0);
            const jointExpenses = periodTrans.filter(t => t.type === 'expense' && t.account === '共同帳戶');
            const totalJointExpense = jointExpenses.reduce((sum, t) => sum + convertToTWD(t.amount, t.currency), 0);
            const placeholder = document.getElementById('joint-expenses-placeholder');
            let html = `
                <p class="text-sm text-gray-500 text-right mb-2">統計區間: ${startDate.getMonth()+1}/${startDate.getDate()} ~ ${endDate.getMonth()+1}/${endDate.getDate()}</p>
                <div class="mb-6"><h4 class="font-bold text-primary mb-3"><i class="fas fa-hand-holding-dollar mr-2"></i>本月投入資金</h4><div class="space-y-3"><div class="bg-blue-50 p-3 rounded-lg border border-blue-100"><div class="flex justify-between items-center"><span class="text-blue-800 font-medium">我的轉帳投入</span><span class="text-blue-800 font-bold">+${formatCurrency(userContribution, 'TWD')}</span></div></div><div class="bg-orange-50 p-3 rounded-lg border border-orange-100"><div class="flex justify-between items-center"><span class="text-orange-800 font-medium">隊友/外部投入</span><span class="text-orange-800 font-bold">+${formatCurrency(partnerContribution, 'TWD')}</span></div></div></div></div>
                <div><div class="flex justify-between items-end mb-3 border-b pb-2 border-base"><h4 class="font-bold text-primary"><i class="fas fa-receipt mr-2"></i>本月共同支出</h4><span class="text-red-600 font-bold text-lg">-${formatCurrency(totalJointExpense, 'TWD')}</span></div><div class="space-y-2">${jointExpenses.length === 0 ? '<p class="text-center text-gray-400 py-4">尚無支出紀錄</p>' : ''}${jointExpenses.map(t => `<div class="p-2 hover:bg-gray-50 rounded border-b border-gray-100 last:border-0"><div class="flex justify-between items-center text-sm"><span>${t.name}</span><span class="font-medium text-gray-700">-${formatCurrency(t.amount, t.currency)}</span></div>${t.note ? `<div class="text-xs text-gray-400 mt-1 pl-1"><i class="fas fa-sticky-note mr-1"></i>${t.note}</div>` : ''}</div>`).join('')}</div></div>`;
            const historyStats = {};
            appData.transactions.forEach(t => {
                const date = new Date(t.timestamp); const key = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                if (!historyStats[key]) historyStats[key] = { user: 0, partner: 0, expense: 0 };
                const amountTWD = convertToTWD(t.amount, t.currency);
                if (t.type === 'transfer' && t.toAccount === '共同帳戶') historyStats[key].user += amountTWD;
                else if (t.type === 'income' && t.account === '共同帳戶') historyStats[key].partner += amountTWD;
                else if (t.type === 'expense' && t.account === '共同帳戶') historyStats[key].expense += amountTWD;
            });
            const sortedKeys = Object.keys(historyStats).sort((a, b) => b.localeCompare(a));
            let overviewHtml = `<div class="mt-10 pt-6 border-t-2 border-dashed border-base/50"><h4 class="font-bold text-primary mb-4 text-lg"><i class="fas fa-chart-line mr-2"></i>年度/每月收支總覽</h4><div class="overflow-x-auto"><table class="w-full text-xs sm:text-sm text-center border-collapse"><thead class="bg-primary text-white"><tr><th class="p-2 rounded-tl-lg">月份</th><th class="p-2">我投入</th><th class="p-2">隊友投入</th><th class="p-2">支出</th><th class="p-2 rounded-tr-lg">結餘</th></tr></thead><tbody class="bg-white divide-y divide-gray-100">`;
            if (sortedKeys.length === 0) overviewHtml += `<tr><td colspan="5" class="p-4 text-gray-500">尚無共同帳戶交易紀錄</td></tr>`;
            else sortedKeys.forEach(key => {
                const stats = historyStats[key];
                if (stats.user === 0 && stats.partner === 0 && stats.expense === 0) return;
                const net = (stats.user + stats.partner) - stats.expense;
                overviewHtml += `<tr class="hover:bg-secondary/30 transition"><td class="p-2 font-bold text-gray-600 border-r border-gray-100">${key}</td><td class="p-2 text-blue-600">+${formatCurrency(stats.user, 'TWD')}</td><td class="p-2 text-orange-600">+${formatCurrency(stats.partner, 'TWD')}</td><td class="p-2 text-red-600">-${formatCurrency(stats.expense, 'TWD')}</td><td class="p-2 font-bold ${net >= 0 ? 'text-green-600' : 'text-red-600'}">${net > 0 ? '+' : ''}${formatCurrency(net, 'TWD')}</td></tr>`;
            });
            overviewHtml += `</tbody></table></div><p class="text-[10px] text-gray-400 mt-2 text-right">*總覽表採自然月(1號~月底)計算</p></div>`;
            html += overviewHtml;
            if(placeholder) placeholder.innerHTML = html;
        }
        function checkUrlAndQuickAdd() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('action') === 'add') {
                const amount = parseFloat(params.get('amount'));
                if (!isNaN(amount) && amount > 0) {
                    saveNewTransaction(`${params.get('category') || '飲食'}-${params.get('subcategory') || '其他'}`, amount, 'TWD', params.get('type') || 'expense', params.get('account') || '現金', null, params.get('note') || '快速記帳', Date.now());
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        }
        function getCardCycle(billingDay) {
            const now = new Date(); const currentDay = now.getDate();
            let startDate, endDate;
            if (currentDay > billingDay) { startDate = new Date(now.getFullYear(), now.getMonth(), billingDay + 1); endDate = new Date(now.getFullYear(), now.getMonth() + 1, billingDay, 23, 59, 59); } 
            else { startDate = new Date(now.getFullYear(), now.getMonth() - 1, billingDay + 1); endDate = new Date(now.getFullYear(), now.getMonth(), billingDay, 23, 59, 59); }
            return { startDate, endDate };
        }
        function renderCreditCardPrep() {
            const container = document.getElementById('credit-card-prep-list');
            if(!container) return;
            container.innerHTML = '';
            const accountMap = {}; 
            appData.creditCards.forEach(card => {
                if (!accountMap[card.linkedAccount]) {
                    const assetInfo = appData.assets.find(a => a.name === card.linkedAccount) || { name: card.linkedAccount, amount: 0, currency: 'TWD' };
                    accountMap[card.linkedAccount] = { info: assetInfo, cards: [], totalCardExpense: 0 };
                }
                const { startDate, endDate } = getCardCycle(card.billingDay);
                accountMap[card.linkedAccount].cards.push({ ...card, cycleStart: startDate, cycleEnd: endDate, amount: 0 });
            });
            appData.transactions.forEach(t => {
                if (t.type !== 'expense') return;
                const tDate = new Date(t.timestamp);
                for (const accName in accountMap) {
                    const group = accountMap[accName];
                    const matchedCardData = group.cards.find(c => c.name === t.account);
                    if (matchedCardData && tDate >= matchedCardData.cycleStart && tDate <= matchedCardData.cycleEnd) {
                        group.totalCardExpense += convertToTWD(t.amount, t.currency);
                        matchedCardData.amount += convertToTWD(t.amount, t.currency);
                        break; 
                    }
                }
            });
            if (Object.keys(accountMap).length === 0) { container.innerHTML = '<p class="text-gray-500 text-center">尚無信用卡設定。</p>'; return; }
            for (const accName in accountMap) {
                const group = accountMap[accName];
                const accountBalance = convertToTWD(group.info.amount, group.info.currency);
                const remaining = accountBalance - group.totalCardExpense;
                const isDanger = remaining < 0;
                const cardDetailsHtml = group.cards.map(c => `<div class="flex justify-between text-xs text-gray-500 mt-1 pl-2 border-l-2 border-base"><span>${c.name} <span class="text-[10px] bg-gray-100 rounded px-1">${c.cycleStart.getMonth()+1}/${c.cycleStart.getDate()}~${c.cycleEnd.getMonth()+1}/${c.cycleEnd.getDate()}</span></span><span>$${formatCurrency(c.amount, 'TWD')}</span></div>`).join('');
                container.innerHTML += `<div class="bg-secondary/30 p-3 rounded-lg border border-base/50"><div class="flex justify-between items-start mb-2"><div><p class="font-bold text-primary">${accName}</p></div><div class="text-right"><p class="text-xs text-gray-500">帳戶餘額</p><p class="font-medium text-primary">${formatCurrency(accountBalance, 'TWD')}</p></div></div><div class="space-y-1 mb-2">${cardDetailsHtml}</div><div class="flex justify-between items-center text-sm border-t border-gray-200 pt-2 mt-1"><span class="text-gray-600 font-medium">總預計扣款</span><span class="font-bold text-red-600">-${formatCurrency(group.totalCardExpense, 'TWD')}</span></div><div class="flex justify-between items-center text-sm mt-1"><span class="text-gray-600">預估剩餘</span><span class="font-bold ${isDanger ? 'text-red-600' : 'text-green-600'}">${formatCurrency(remaining, 'TWD')}${isDanger ? '<i class="fas fa-exclamation-circle ml-1"></i>' : ''}</span></div></div>`;
            }
        }
        function toggleAccordion(id) {
            const content = document.getElementById(id);
            const icon = document.getElementById(`${id}-icon`);
            if (content.classList.contains('hidden')) { content.classList.remove('hidden'); if(icon) icon.classList.add('rotate-180'); }
            else { content.classList.add('hidden'); if(icon) icon.classList.remove('rotate-180'); }
        }
        function triggerImport() { document.getElementById('import-file').click(); }
        function handleFileImport(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (!json.transactions || !json.exchangeRates) throw new Error('無效的資料格式');
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(json));
                    // Reload data
                    loadData();
                    renderAssets(); renderFixedPlan(); renderCreditCardPrep(); renderMonthlyBillDue(); renderTransactionHistory(); renderMonthlyStats(); renderCurrentYearStats(); initHistoricalStats(); renderJointAccount(); renderGoalTab();
                    showAlert('success', '資料匯入成功！已更新畫面。');
                } catch (err) { console.error(err); showAlert('danger', '匯入失敗：檔案格式錯誤'); }
                input.value = '';
            };
            reader.readAsText(file);
            closeDataModal();
        }
        function exportData() {
            const dataStr = JSON.stringify(JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY)), null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `winds_finance_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            closeDataModal();
        }
        function openDataModal() { document.getElementById('data-modal').classList.remove('hidden'); }
        function closeDataModal() { document.getElementById('data-modal').classList.add('hidden'); }

        // --- Tab 導航 ---
        function setupTabs() {
            const buttons = document.querySelectorAll('.nav-button');
            const contents = document.querySelectorAll('.tab-content');
            
            function switchTab(targetId) {
                buttons.forEach(btn => {
                    const isActive = btn.dataset.tab === targetId;
                    btn.classList.toggle('active', isActive);
                    btn.classList.toggle('text-gray-500', !isActive);
                    btn.classList.toggle('text-accent', isActive);
                });
                
                contents.forEach(content => {
                    content.classList.toggle('hidden', content.id !== `${targetId}-tab`);
                });
                renderTabContent(targetId);
            }

            buttons.forEach(button => {
                button.addEventListener('click', () => switchTab(button.dataset.tab));
            });
            switchTab('assets');
        }

        function renderTabContent(tabId) {
            switch (tabId) {
                case 'assets':
                    renderAssets();
                    renderGoalTab();
                    break;
                case 'plan':
                    renderFixedPlan(); 
                    renderMonthlyBillDue(); 
                    renderCreditCardPrep(); 
                    break;
                case 'bookkeeping':
                    renderBookkeepingFormOptions();
                    initCategorySelects(); 
                    renderTransactionHistory();
                    renderMonthlyStats(); 
                    renderCurrentYearStats(); 
                    initHistoricalStats(); 
                    break;
                case 'joint':
                    renderJointAccount();
                    break;
                case 'goal':
                    renderGoalTab();
                    break;
            }
        }

        window.onload = function() {
            loadData();
            setupTabs();
            renderAssets();
            renderFixedPlan();
            renderCreditCardPrep();
            renderMonthlyBillDue(); // 新增：啟動時渲染本月信用卡帳單
            renderBookkeepingFormOptions();
            setTransactionDateDefault(); 
            initCategorySelects(); 
            renderTransactionHistory();
            renderMonthlyStats(); 
            renderCurrentYearStats(); 
            initHistoricalStats(); 
            renderJointAccount();
            renderGoalTab();
            checkUrlAndQuickAdd();
            fetchExchangeRates();
        };
    </script>
</body>
</html>
